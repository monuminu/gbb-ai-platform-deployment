import{e as Q,j as e,S as T,h as Y,A as ie,T as K,m as le,C as pe,D as re,a9 as xe,r,N as q,d as A,I as ge,B as ce,o as U,v as fe,a as Z,y as V,p as X,a3 as Se,i as je,E as ee,aa as be,F as ye}from"./index-f7c4dfad.js";import{_ as Ce,U as we,c as ve,a as Le,b as ke}from"./attach-2-fill-7e40e49b.js";import"./index-8fda52a8.js";import{u as Re,o as te,g as Ie}from"./use-messages-scroll-6244af21.js";import{L as Te}from"./numeral-b65a1435.js";import{R as Pe}from"./rag-source-dialog-bf54fa9f.js";import{b as Ne,u as We}from"./tool-f255544f.js";import{m as se}from"./api-c77678a4.js";import{u as de,a as he}from"./use-light-box-1c577ab5.js";import{p as Ee,q as _e,r as Oe,t as $e,u as Ae}from"./ChatMessageInputWebPopover-38e1844e.js";import{b as Fe}from"./DialogContent-12fa3194.js";import{_ as Be}from"./round-send-ef8614b3.js";import"./coming-soon-image-464dfa9d.js";import{M as Ue}from"./preview-multi-file-bce21d5d.js";import"./image-f9ea5de7.js";import{v as De}from"./fade-295cf198.js";import{_ as ze}from"./close-fill-84c0bbed.js";import{a as He}from"./TextField-5cd6dfc4.js";function Me({customGpt:c,onSetCurrentGpt:l}){const S=Q(),{name:y,description:o,coverUrl:d}=c,i=()=>{l(c)};return e.jsx(Fe,{onClick:i,sx:{px:1.25,py:1.5,borderRadius:1.25,background:"background.paper","&:hover":{opacity:.9,transition:S.transitions.create("opacity"),boxShadow:a=>a.customShadows.z20}},children:e.jsxs(T,{direction:"row",spacing:1.25,alignItems:"center",sx:{height:"100%"},children:[e.jsx(Y,{sx:{mx:1},children:e.jsx(ie,{alt:"copilot",src:d,sx:{width:48,height:48,mx:"auto"}})}),e.jsxs(T,{spacing:1,sx:{height:"100%"},children:[e.jsx(K,{variant:"h6",children:y||""}),e.jsx(K,{variant:"body2",sx:{pr:.75,display:"-webkit-box",overflow:"hidden",fontSize:"13px",textOverflow:"ellipsis",WebkitBoxOrient:"vertical",WebkitLineClamp:2},children:o||""})]})]})})}const qe=["jpg","gif","png","gif","bmp","svg","webp"],ne=new RegExp(`https.*\\.(${qe.join("|")}).*(?=\\))`,"i"),oe=/!\[.*?\]\((.*?)\)/g;function Ye({customGpts:c,conversation:l,currentGpt:S,onSetCurrentGpt:y,onOpenRagSourcePopover:o}){const{messagesEndRef:d}=Re(l.messages),i=l.messages.filter(n=>{if(!n.body)return!1;const u=n.body.match(ne);return!!(u?u[0]:"")}).map(n=>{if(!n.body)return{src:""};const u=n.body.match(ne),g=u?u[0]:"",p=[];let j=oe.exec(n.body);for(;j!==null;)j[1]!==g&&p.push(j[1]),j=oe.exec(n.body);return[{src:g},...p.map(f=>({src:f}))]}).flat();l.messages.forEach(n=>{n.attachments!==void 0&&n.attachments.length>0&&n.attachments.forEach(u=>{i.push({src:u.preview})})});const a=de(i),x=n=>{a.onOpen(n)};return e.jsxs(e.Fragment,{children:[e.jsxs(le,{ref:d,sx:{py:2,px:1.25,height:1},children:[e.jsxs(Y,{sx:{mx:1,mb:8,mt:0},children:[e.jsx(Ee,{title:"Agent Workbench"}),e.jsx(K,{variant:"subtitle2",sx:{px:0,mt:4,mb:2,textAlign:"center"},children:"Select a custom GPT"}),e.jsx(Y,{sx:{display:"grid",gap:3,gridTemplateColumns:{xs:"repeat(1, 1fr)",sm:"repeat(2, 1fr)",md:"repeat(3, 1fr)",lg:"repeat(3, 1fr)"},width:"100%"},children:c.slice(0,6).map(n=>e.jsx(Me,{customGpt:n,onSetCurrentGpt:y},n.id))})]}),l.messages.map((n,u)=>e.jsx(_e,{message:n,avatarName:n.avatarName||"Copilot",avatarUrl:n.avatarUrl||"",conversation:l,isLastMessage:u===l.messages.length-1,onOpenLightbox:x,onOpenRagSourcePopover:o},n.id))]}),e.jsx(he,{index:a.selected,slides:i,open:a.open,close:a.onClose})]})}function Ke({openPopover:c,samplePrompts:l,setOpenPopover:S,setMessage:y}){const o=Q(),d=()=>{S(null)};return e.jsxs(pe,{open:c,onClose:d,arrow:"bottom-center",sx:{width:360,boxShadow:o.customShadows.z8},hiddenArrow:!0,style:{transform:"translateY(-18px)"},children:[e.jsx(K,{variant:"subtitle1",sx:{py:1,pb:1.5,px:1},children:"Prompt library"}),e.jsx(re,{sx:{borderStyle:"dashed"}}),e.jsx(le,{sx:{mt:1,height:{xs:300,sm:380}},children:e.jsx(xe.div,{variants:De().inUp,children:l.map((i,a)=>e.jsx(Oe,{selected:!1,onSelectQuery:y,title:i,prompt:i},a))})})]})}const Ge={width:24,height:24,body:'<path fill="currentColor" d="m9 4l2.5 5.5L17 12l-5.5 2.5L9 20l-2.5-5.5L1 12l5.5-2.5L9 4m0 4.83L8 11l-2.17 1L8 13l1 2.17L10 13l2.17-1L10 11L9 8.83M19 9l-1.26-2.74L15 5l2.74-1.25L19 1l1.25 2.75L23 5l-2.75 1.26L19 9m0 14l-1.26-2.74L15 19l2.74-1.25L19 15l1.25 2.75L23 19l-2.75 1.26L19 23Z"/>'};var Je=Ge;function Qe({currentGpt:c,onClearGpt:l,handleOpenPopover:S}){const y=Q(),[o,d]=r.useState(!1),i=o?32:40,a=o?.5:0;return e.jsxs(e.Fragment,{children:[c&&e.jsxs(T,{direction:"row",alignItems:"center",spacing:1,sx:{p:a,mr:.25,height:40,borderRadius:20,background:q(y.palette.grey[500],.16)},onMouseEnter:()=>{d(!0)},onMouseLeave:()=>{d(!1)},onClick:S,children:[e.jsx(ie,{alt:c.name,src:c.coverUrl,sx:{width:i,height:i}}),o&&e.jsxs(e.Fragment,{children:[e.jsx(K,{variant:"body2",noWrap:!0,children:c.name}),e.jsx(A,{size:"small",onClick:x=>{x.stopPropagation(),l(),d(!1)},children:e.jsx(ge,{icon:ze})})]})]}),!c&&e.jsx(ce,{variant:"soft",color:"inherit",onClick:S,startIcon:e.jsx(U,{icon:Je}),sx:{width:40,maxWidth:40,minWidth:40,height:40,padding:1,paddingRight:1,borderRadius:20,whiteSpace:"nowrap",mr:1,"& .MuiButton-startIcon":{mx:0}}})]})}function Ze({disabled:c,customGpts:l,participants:S,onSend:y,chatMode:o,currentGpt:d,onSetCurrentGpt:i}){const a=Q(),x=r.useRef(null),n=r.useRef(null),[u,g]=r.useState(0),[p,j]=r.useState(""),[f,P]=r.useState([]),[h,D]=r.useState(0),[E,C]=r.useState(!1),[w,m]=r.useState(null),[v,L]=r.useState(null),k=t=>{i(t),p.startsWith("@")&&j("")},_=()=>{i(null)},R=f.map(t=>({src:t.preview})),b=de(R),I=t=>{b.onOpen(t)},z=t=>{m(t.currentTarget)},H=t=>{L(t.currentTarget)},O=t=>{t.target.value.startsWith("@")?L(n.current):L(null)},N=()=>{L(null)};r.useEffect(()=>{const t=setTimeout(()=>{s()},50);return()=>clearTimeout(t)},[p]),r.useEffect(()=>{v&&x.current&&D(x.current.offsetWidth)},[v]);const s=()=>{const t=document.querySelector(".llm-input");if(t){let W;t.clientHeight<60?W=1:t.clientHeight>=60&&t.clientHeight<80?W=2:t.clientHeight>=80&&t.clientHeight<100?W=3:W=4,g(W)}},$=t=>{C(t)},G=t=>{(t.metaKey||t.ctrlKey)&&t.key==="Enter"&&M()},F=S===null?[]:S.map(t=>t.id),M=()=>{!p||S===null||(y({content:p,senderId:"user",mode:"new",attachments:f}),y({content:"(SYS)Working on it...",senderId:F[0],mode:"new"}),j(""),P([]),g(1))},me=r.useCallback(t=>{const W=t.map(J=>Object.assign(J,{preview:URL.createObjectURL(J)}));P([...f,...W])},[f]),ue=r.useCallback(t=>{const W=f.filter(J=>J!==t);P(W)},[f]);let B;return f.length>0?B=1:u<2?B=20:u===2?B=2.5:u===3?B=2:B=1.5,e.jsxs(Y,{ref:x,sx:{minHeight:52,display:"flex",position:"absolute",alignItems:"center",bottom:-64,width:"100%",paddingLeft:a.spacing(.75),backgroundColor:a.palette.background.paper,py:.5,boxShadow:E?`0 0 1px 0 ${q(a.palette.mode==="light"?a.palette.grey[500]:a.palette.grey[200],.32)}, 0 1px 10px 2px ${q(a.palette.mode==="light"?a.palette.grey[800]:a.palette.grey[700],.1)}`:`0 0 1px 0 ${q(a.palette.mode==="light"?a.palette.grey[500]:a.palette.grey[200],.32)}, 0 1px 4px -1px ${q(a.palette.mode==="light"?a.palette.grey[800]:a.palette.grey[700],.34)}`,borderRadius:B},children:[e.jsx("div",{ref:n,children:e.jsx(Qe,{currentGpt:d,onClearGpt:_,handleOpenPopover:H})}),e.jsxs(T,{sx:{mx:.5},children:[e.jsx(A,{size:"small",onClick:z,children:e.jsx(U,{icon:Ce,width:22})}),e.jsx(Ke,{openPopover:w,samplePrompts:d?d.samplePrompts:[],setMessage:j,setOpenPopover:m})]}),e.jsxs(T,{sx:{width:"100%"},alignItems:"center",children:[e.jsx(T,{direction:"row",flexWrap:"wrap",sx:{display:f.length===0?"none":"flex",width:"100%",mt:.75,ml:-1},children:e.jsx(Ue,{thumbnail:!0,files:f,onRemove:t=>ue(t),sx:{width:64,height:64},onClick:I})}),e.jsx(He,{className:"llm-input",multiline:!0,maxRows:10,fullWidth:!0,value:p,disableUnderline:!0,onBlur:()=>$(!1),onFocus:()=>$(!0),onKeyDown:G,onChange:t=>{j(t.target.value),O(t)},placeholder:"Enter a message",endAdornment:e.jsxs(T,{direction:"row",sx:{mr:.5,"& > *":{mx:.25}},alignItems:"center",children:[e.jsx(we,{disabled:o!=="open-chat",onDrop:me}),e.jsx(A,{disabled:c,size:"small",onClick:()=>{},children:e.jsx(U,{icon:ve,width:20,height:20})}),e.jsx(A,{disabled:c,size:"small",children:e.jsx(U,{icon:Le,width:20,height:20})})]}),sx:{pb:.5}})]}),e.jsx(re,{orientation:"vertical",flexItem:!0}),e.jsx(A,{disabled:p.trim().length===0,onClick:M,sx:{mx:1,mr:.75,color:"#3f8bcf"},children:e.jsx(U,{icon:Be,width:24,height:24})}),e.jsx(he,{index:b.selected,slides:R,open:b.open,close:b.onClose}),e.jsx($e,{searchText:p.startsWith("@")?p.slice(1):"",customGpts:l,anchorWidth:h,openPopover:v,onClosePopover:N,onSetCurrentGpt:k})]})}const Ve={id:"user",name:"Admin"},ae=[{id:"assistant",name:"GPT"}];function Xe({customGpts:c,currentGpt:l,setCurrentGpt:S,messages:y,chatMode:o,onUpdateMessages:d,configurations:i,selectedIndex:a,selectedToolNames:x,onOpenRagSourcePopover:n}){const{tools:u}=Ne();let g=[],p=[];x&&x.length>0&&(g=u.filter(C=>x.some(w=>{const[m]=w.split("<sep>");return m===C.id&&C.meta.trim()!==""})),p=g.map(C=>JSON.parse(C.meta)));const j=C=>{S(C)},f=i[`${o}-Past messages included`],P=C=>{const{messageId:w,message:m,contentType:v,sources:L,function_calls:k,createdAt:_,senderId:R,mode:b,ddb_uuid:I,log_timestamp:z,attachments:H,thoughts:O}=C,N={id:w,body:m,contentType:v,sources:L,function_calls:k,createdAt:_,senderId:R,mode:b,chatMode:o,ddb_uuid:I,avatarName:(l==null?void 0:l.name)||"",avatarUrl:(l==null?void 0:l.coverUrl)||"",log_timestamp:z,attachments:H,thoughts:O};d(s=>{const $=s.findIndex(F=>F.id===w);if(!m)return[...s];if($===-1){if(b==="attach"){if(m.startsWith("(SYS)function")){const M={...s[s.length-1],body:m,function_calls:k};return m.startsWith("(SYS)function executed")&&se({mode:o,onSend:E,request:te([...s.slice(0,-1),M],o,f,i,[],p),shouldStream:i[`${o}-Should stream`],aoaiResourceName:i[`${o}-Deployment`],indexName:a,systemPrompt:i[`${o}-System message`],selectedTools:g}),[...s.slice(0,-1),M]}const F=s[s.length-1].function_calls;return[...s.slice(0,-1),{...s[s.length-1],body:m,...O&&{thoughts:O},...F&&{function_calls:F}}]}return b==="new"&&m!=="(SYS)Working on it..."&&R==="assistant"?[...s.slice(0,-1),N]:b==="new"&&R==="user"?(se({mode:o,onSend:E,request:te([...s.slice(0,-1),N],o,f,i,[],p),shouldStream:i[`${o}-Should stream`],aoaiResourceName:i[`${o}-Deployment`],indexName:a,systemPrompt:i[`${o}-System message`],selectedTools:g}),[...s,N]):[...s,N]}const G=[...s];return G[$]=N,G})},h=[ae[0]],D={id:"1",participants:[Ve,ae[0]],type:"ONE_TO_ONE",unreadCount:0,messages:y},E=({content:C,senderId:w,mode:m,sources:v=[],function_calls:L=[],msgId:k=void 0,uuid:_=void 0,timestamp:R=void 0,attachments:b=[],thoughts:I=[]})=>{P({conversationId:"1",messageId:k===void 0?We():k,message:C,contentType:"text",sources:v,function_calls:L,createdAt:new Date,senderId:w,mode:m,chatMode:o,ddb_uuid:_,log_timestamp:R,attachments:b,thoughts:I})};return e.jsxs(T,{sx:{width:1,height:1,overflow:"hidden"},children:[e.jsx(Ye,{customGpts:c,conversation:D,currentGpt:l,onSetCurrentGpt:j,onOpenRagSourcePopover:n}),e.jsx(Ze,{customGpts:c,participants:h,onSend:E,disabled:!0,chatMode:o,currentGpt:l,onSetCurrentGpt:j})]})}function St({id:c,customGpts:l,clickSource:S}){const y=fe(),o=Z(),d=Z(),[i,a]=r.useState(),[x,n]=r.useState("open-chat"),[u,g]=r.useState(""),[p,j]=r.useState([]),[f,P]=r.useState([]),[h,D]=r.useState(null),[E,C]=r.useState("All"),w=V(ye),m=w?w.map(s=>s.resourceName):[],v=w?w.filter(s=>s.primary):[],L=v&&v.length>0?v[0].resourceName:"";let k="";L.length>0?k=L:m&&m.length>0&&(k=m[0]);const _=V(c),R=Ie(k),[b,I]=r.useState({...R,..._});r.useEffect(()=>{h?h.functionList&&h.functionList.length>0?(n("function-calling"),g(""),I(s=>({...s,...h&&{"function-calling-System message":h.instruction}})),P(h.functionList)):h.knowledgeBase&&h.knowledgeBase.length>0?(n("rag"),P([]),I(s=>({...s,...h&&{"rag-System message":h.instruction}})),g(h.knowledgeBase.split("<sep>")[1])):(n("open-chat"),g(""),P([]),I(s=>({...s,...h&&{"open-chat-System message":h.instruction}}))):(n("open-chat"),g(""),I(s=>({...s,"open-chat-System message":R[`${x.toLowerCase()}-System message`]})))},[h]);const z=s=>{I(s),be(c,s)},H=()=>{j([])},O=r.useCallback((s,$)=>{a(s),C($),d.onTrue()},[d]),N=y.themeLayout==="horizontal";return e.jsxs(e.Fragment,{children:[e.jsxs(T,{direction:"row",justifyContent:"space-between",alignItems:"center",sx:{mb:.5},children:[e.jsx(ce,{to:S==="gpts"?X.gbbai.gpts.root:X.gbbai.appGallery.root,component:Se,size:"small",color:"inherit",startIcon:e.jsx(U,{icon:ke,style:{marginRight:"-5px"}}),sx:{display:"flex"},children:"Back"}),e.jsxs(T,{direction:"row",alignItems:"center",children:[e.jsx(Te,{color:"default",sx:{textTransform:"None",mr:1.5},children:b[`${x}-Deployment`]||"No GPT deployment"}),e.jsx(je,{title:"Clear histroy",children:e.jsx(A,{size:"small",color:"default",onClick:H,sx:{width:36,height:36},children:e.jsx(ee,{src:"/assets/icons/modules/ic-sweep.svg",sx:{width:22,height:22}})})}),e.jsx(A,{size:"small",color:"default",onClick:o.onTrue,sx:{width:36,height:36},children:e.jsx(ee,{src:"/static/icons/apps/ic_settings.svg",sx:{width:20,height:20}})})]})]}),e.jsx(Y,{sx:{height:N?"calc(100vh - 328px)":"calc(100vh - 204px)",display:"flex",position:"relative",overflow:"visible"},children:e.jsx(Xe,{chatMode:x,customGpts:l,messages:p,currentGpt:h,setCurrentGpt:D,onUpdateMessages:j,configurations:b,selectedIndex:u,selectedToolNames:f,onOpenRagSourcePopover:O})}),e.jsx(Ae,{open:o.value,chatMode:x,onClose:o.onFalse,configurations:b,onUpdate:z}),e.jsx(Pe,{open:d.value,onClose:d.onFalse,ragThoughts:i,selectedSource:E})]})}export{St as C,Je as _};
