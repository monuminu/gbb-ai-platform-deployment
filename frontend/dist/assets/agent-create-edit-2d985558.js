import{j as e,L as Re,ab as Qe,v as Ne,a as ce,r as f,y as ge,T as te,B as se,D as V,w as De,S as b,p as pe,a3 as Xe,o as ie,i as fe,d as F,E as de,h as M,F as je,e as Ze,m as ye,I as K,A as re,x as Le,n as et,z as tt,ac as st,ad as nt,ae as ot,l as at,g as it,W as rt}from"./index-f7c4dfad.js";import{u as lt}from"./use-params-075b74e1.js";import{a as ct}from"./custom-gpt-chat-bench-message-item-2678e8e2.js";import{S as dt}from"./index-8fda52a8.js";import{C as Ee}from"./numeral-b65a1435.js";import"./knowledge-9078246a.js";import"./ChatMessageInputWebPopover-38e1844e.js";import{S as mt,a as ut,r as pt,b as ht,c as xt,M as gt}from"./markdown-e1ecb202.js";import{I as ft,E as Oe}from"./image-f9ea5de7.js";import{E as jt}from"./coming-soon-image-464dfa9d.js";import{R as Me,u as yt}from"./rag-source-dialog-bf54fa9f.js";import{R as bt}from"./index-491c3250.js";import{e as Fe,C as be,R as he,c as wt,a as J,d as oe,b as Pe,f as me,u as St,F as Ct,o as vt}from"./rhf-autocomplete-204470f7.js";import{_ as kt}from"./cloud-upload-fill-a41285d1.js";import{b as Ue,u as le,L as It,D as Rt}from"./tool-f255544f.js";import{i as Pt}from"./json-string-62cd4b84.js";import{u as $t,g as Tt,a as _t}from"./app-gallery-78b50b87.js";import{C as Nt}from"./custom-breadcrumbs-4cb50d46.js";import{b as Dt,_ as Lt,U as ze,c as Et}from"./attach-2-fill-7e40e49b.js";import{g as we,u as Ae,o as Z}from"./use-messages-scroll-6244af21.js";import{C as Ot}from"./ChatWindow-19ab5a84.js";import{D as We,a as Be,b as qe,C as xe,c as Mt}from"./DialogContent-12fa3194.js";import{L as He,_ as Ft}from"./plus-fill-f9c9dd5d.js";import{m as ee}from"./api-c77678a4.js";import{_ as Ut}from"./round-send-ef8614b3.js";import{M as Ye}from"./preview-multi-file-bce21d5d.js";import{F as Ke,b as zt,c as At,a as Wt,I as Bt,T as qt}from"./TextField-5cd6dfc4.js";import{u as Ge,a as Je,L as Ht}from"./use-light-box-1c577ab5.js";import{a as Yt}from"./rhf-upload-aff1832d.js";import{R as ae}from"./rhf-text-field-2f3dfe59.js";import{F as Se}from"./confirm-dialog-e205398d.js";import{R as Kt}from"./Radio-50d033bf.js";import{u as Gt,_ as Jt}from"./use-get-message-377020ea.js";import{f as Vt}from"./file-thumbnail-ebe9c7d7.js";import{S as Ve}from"./custom-date-range-picker-998109e2.js";import{_ as Qt}from"./close-fill-84c0bbed.js";import{L as Xt}from"./ListItemIcon-eab82116.js";import{G as ue}from"./Grid2-f7b90094.js";import"./more-horizontal-fill-3cef82a0.js";import"./arrow-ios-forward-fill-2d56b1a6.js";import"./format-number-ad5a4a25.js";import"./SkeletonBoxTable-cedfa69a.js";import"./motion-container-9bab03e7.js";import"./container-3f1c2166.js";import"./Tabs-e58d3a15.js";import"./fade-295cf198.js";import"./transition-bee6630b.js";import"./upload-1fbeb8f8.js";function $e({name:n,size:c,helperText:u,...p}){const{control:y}=Fe();return e.jsx(be,{name:n,control:y,render:({field:o,fieldState:{error:a}})=>e.jsxs("div",{children:[e.jsx(Se,{control:e.jsx(Ve,{size:c||"medium",...o,checked:o.value}),...p}),(!!a||u)&&e.jsx(Ke,{error:!!a,children:a?a==null?void 0:a.message:u})]})})}function Zt({row:n,name:c,label:u,options:p,spacing:y,helperText:o,...a}){const{control:m}=Fe(),s=u?`${c}-${u}`:"";return e.jsx(be,{name:c,control:m,render:({field:i,fieldState:{error:x}})=>e.jsxs(zt,{component:"fieldset",children:[u&&e.jsx(At,{component:"legend",id:s,sx:{typography:"body2"},children:u}),e.jsx(bt,{...i,"aria-labelledby":s,row:n,...a,children:p.map(g=>e.jsx(Se,{value:g.value,control:e.jsx(Kt,{}),label:g.label,sx:{"&:not(:last-of-type)":{mb:y||0},...n&&{mr:0,"&:not(:last-of-type)":{mr:y||2}}}},g.value))}),(!!x||o)&&e.jsx(Ke,{error:!!x,sx:{mx:0},children:x?x==null?void 0:x.message:o})]})})}function es({sx:n,...c}){return e.jsx(mt,{sx:n,children:e.jsx(ut,{rehypePlugins:[pt,ht,[xt,{singleTilde:!1}]],components:ts,...c})})}const ts={img:({...n})=>{const c=n.src.replaceAll("amp;","");return e.jsx(ft,{alt:n.alt,ratio:"1/1",sx:{borderRadius:1,my:1},...n,src:c})},a:({...n})=>n.href.includes("http")?e.jsx(Re,{target:"_blank",rel:"noopener",...n}):e.jsx(Re,{component:Qe,path:n.href,...n,children:n.children})};function ss({title:n,coverUrl:c,instruction:u,description:p,samplePrompts:y,functionList:o,knowledgeBase:a,attachments:m,open:s,isValid:i,onClose:x,onSubmit:g,isSubmitting:t}){let C="open-chat",T;o&&o.length>0?C="function-calling":a&&a.length>0&&(C="rag",T=a.split("<sep>")[1]||void 0);const W=n||p||u||c,S=Ne(),D=ce(),[A,B]=f.useState(),[E,q]=f.useState([]),[d,l]=f.useState("All"),v=ge(je),_=v?v.map(L=>L.resourceName):[],R=v?v.filter(L=>L.primary):[],k=R&&R.length>0?R[0].resourceName:"";let P="";k.length>0?P=k:_&&_.length>0&&(P=_[0]);const H=we(P),[$]=f.useState({...H,[`${C.toLowerCase()}-System message`]:u}),r=()=>{q([])},h=f.useCallback((L,N)=>{B(L),l(N),D.onTrue()},[D]),j=S.themeLayout==="horizontal";return e.jsxs(We,{fullScreen:!0,open:s,onClose:x,PaperProps:{sx:{bgcolor:"background.default"}},children:[e.jsxs(Be,{sx:{py:1.5,px:3},children:[e.jsx(te,{variant:"h6",sx:{flexGrow:1},children:"Preview"}),e.jsx(se,{size:"small",variant:"outlined",color:"inherit",onClick:x,children:"Cancel"}),e.jsx(He,{size:"small",type:"submit",variant:"contained",disabled:!i,loading:t,onClick:g,children:"Publish"})]}),e.jsx(V,{}),W?e.jsxs(De,{maxWidth:S.themeStretch?"xl":"lg",sx:{py:2},children:[e.jsxs(b,{direction:"row",justifyContent:"space-between",alignItems:"center",sx:{mb:.5},children:[e.jsx(se,{to:pe.gbbai.appGallery.root,component:Xe,size:"small",color:"inherit",startIcon:e.jsx(ie,{icon:Dt,style:{marginRight:"-5px"}}),sx:{display:"flex",visibility:"hidden"},children:"Gallery"}),e.jsx(b,{direction:"row",alignItems:"center",children:e.jsx(fe,{title:"Clear histroy",children:e.jsx(F,{size:"small",color:"default",onClick:r,sx:{width:36,height:36},children:e.jsx(de,{src:"/assets/icons/modules/ic-sweep.svg",sx:{width:22,height:22}})})})})]}),e.jsx(M,{sx:{height:j?"calc(100vh - 328px)":"calc(100vh - 204px)",display:"flex",position:"relative",overflow:"visible"},children:e.jsx(Ot,{gptName:n,chatMode:C,avatarUrl:c,description:p,samplePrompts:y,messages:E,onUpdateMessages:q,configurations:$,selectedIndex:T,functionList:o,sampleAttachments:m,onOpenRagSourcePopover:h})}),e.jsx(Me,{open:D.value,onClose:D.onFalse,ragThoughts:A,selectedSource:d})]}):e.jsx(Oe,{filled:!0,title:"Empty Content!"})]})}function ns({onSend:n}){const c=Ze(),[u]=f.useState([]),[p,y]=f.useState(""),o=()=>{p&&(n({content:p,senderId:"user",mode:"new"}),n({content:"(SYS)Working on it...",senderId:"assistant",mode:"new"}),y(""))},a=m=>{(m.metaKey||m.ctrlKey)&&m.key==="Enter"&&o()};return e.jsxs(M,{sx:{bottom:0,width:"100%",minHeight:52,display:"flex",position:"absolute",alignItems:"center",paddingLeft:c.spacing(1),backgroundColor:c.palette.background.paper,borderTop:`solid 1px ${c.palette.divider}`},children:[e.jsx(b,{sx:{mr:1},children:e.jsx(F,{size:"small",onClick:()=>{},children:e.jsx(ie,{icon:Lt,width:22})})}),e.jsxs(b,{sx:{width:"100%"},alignItems:"center",children:[e.jsx(b,{direction:"row",flexWrap:"wrap",sx:{display:u.length===0?"none":"flex",width:"100%",mt:.75,ml:-1},children:e.jsx(Ye,{thumbnail:!0,files:[],onRemove:()=>{},sx:{width:64,height:64},onClick:()=>{}})}),e.jsx(Wt,{multiline:!0,maxRows:5,fullWidth:!0,value:p,disableUnderline:!0,onKeyDown:a,onChange:m=>y(m.target.value),placeholder:"Enter a message",endAdornment:e.jsxs(b,{direction:"row",sx:{mr:.5,"& > *":{mx:.25}},alignItems:"center",children:[e.jsx(ze,{disabled:!1,onDrop:()=>{}}),e.jsx(F,{disabled:!1,size:"small",onClick:()=>{},children:e.jsx(ie,{icon:Et,width:20,height:20})})]}),sx:{pb:.5}})]}),e.jsx(V,{orientation:"vertical",flexItem:!0}),e.jsx(F,{disabled:p.trim().length===0,onClick:o,sx:{mx:1,mr:.75},children:e.jsx(ie,{icon:Ut,width:24,height:24})})]})}const os=["jpg","gif","png","gif","bmp","svg","webp"],Te=new RegExp(`https.*\\.(${os.join("|")}).*(?=\\))`,"i"),_e=/!\[.*?\]\((.*?)\)/g;function as({avatarUrl:n,messages:c=[],participants:u,onOpenRagSourcePanel:p}){const{messagesEndRef:y}=Ae(c),o=c.filter(s=>{if(!s.body)return!1;const i=s.body.match(Te);return!!(i?i[0]:"")}).map(s=>{if(!s.body)return{src:""};const i=s.body.match(Te),x=i?i[0]:"",g=[];let t=_e.exec(s.body);for(;t!==null;)t[1]!==x&&g.push(t[1]),t=_e.exec(s.body);return[{src:x},...g.map(C=>({src:C}))]}).flat();c.forEach(s=>{s.attachments!==void 0&&s.attachments.length>0&&s.attachments.forEach(i=>{o.push({src:i.preview})})});const a=Ge(o),m=s=>{a.onOpen(s)};return e.jsxs(e.Fragment,{children:[c.length===0&&e.jsx(M,{sx:{height:"calc(100% - 52px)",display:"flex",alignItems:"center",flexDirection:"column",justifyContent:"center"},children:e.jsxs(b,{direction:"column",sx:{my:"auto",alignItems:"center"},children:[e.jsx(jt,{sx:{width:180,height:180}}),e.jsx(te,{variant:"h6",color:"text.disabled",sx:{mt:.5},children:"Chat with your GPT"})]})}),c.length>0&&e.jsx(ye,{ref:y,sx:{py:2,px:3,pb:1,height:"calc(100% - 52px)"},children:c.map(s=>e.jsx(ct,{message:s,avatarUrl:n,participants:u,isLastMessage:c.indexOf(s)===c.length-1,onOpenLightbox:m,onOpenRagSourcePanel:p},s.id))}),e.jsx(Je,{index:a.selected,slides:o,open:a.open,close:a.onClose})]})}function is({avatarUrl:n,instruction:c,functionList:u,knowledgeBase:p}){const{tools:y}=Ue();let o="open-chat",a,m=[],s=[];u&&u.length>0?(o="function-calling",m=y.filter($=>u.some(r=>{const[h]=r.split("<sep>");return h===$.id&&$.meta.trim()!==""})),s=m.map($=>JSON.parse($.meta))):p&&p.length>0&&(o="rag",a=p.split("<sep>")[1]||void 0);const i=ce(),[x,g]=f.useState(),[t,C]=f.useState([]),[T,W]=f.useState("All"),S=ge(je),D=S?S.map($=>$.resourceName):[],A=S?S.filter($=>$.primary):[],B=A&&A.length>0?A[0].resourceName:"";let E="";B.length>0?E=B:D&&D.length>0&&(E=D[0]);const q=we(E),[d]=f.useState({...q,[`${o.toLowerCase()}-System message`]:c}),l=d[`${o}-Past messages included`],v=($,r)=>{const{messageId:h,message:j,contentType:L,sources:N,function_calls:O,createdAt:I,senderId:w,mode:U,ddb_uuid:Y,log_timestamp:G,attachments:Ce,thoughts:Q}=$,X={id:h,body:j,contentType:L,sources:N,function_calls:O,createdAt:I,senderId:w,mode:U,chatMode:o,ddb_uuid:Y,log_timestamp:G,attachments:Ce,thoughts:Q};C(z=>{const ve=z.findIndex(ne=>ne.id===h);if(!j)return[...z];if(ve===-1){if(U==="attach"){if(j.startsWith("(SYS)function")){const Ie={...z[z.length-1],body:j,function_calls:O};return j.startsWith("(SYS)function executed")&&ee({mode:o,onSend:P,request:Z([...z.slice(0,-1),Ie],o,l,d,[],s),shouldStream:d[`${o}-Should stream`],aoaiResourceName:d[`${o}-Deployment`],systemPrompt:d[`${o}-System message`],selectedTools:m}),[...z.slice(0,-1),Ie]}const ne=z[z.length-1].function_calls;return[...z.slice(0,-1),{...z[z.length-1],body:j,...ne&&{function_calls:ne},...Q&&{thoughts:Q}}]}return U==="new"&&j!=="(SYS)Working on it..."&&w==="assistant"?[...z.slice(0,-1),X]:U==="new"&&w==="user"?(r?ee({mode:o,onSend:P,request:Z([...z,X],o,l,d,[],s),shouldStream:d[`${o}-Should stream`],aoaiResourceName:d[`${o}-Deployment`],indexName:a,systemPrompt:d[`${o}-System message`],selectedTools:m}):ee({mode:o,onSend:P,request:Z([...z,X],o,l,d,[],s),shouldStream:d[`${o}-Should stream`],aoaiResourceName:d[`${o}-Deployment`],indexName:a,systemPrompt:d[`${o}-System message`],selectedTools:m}),[...z,X]):[...z,X]}const ke=[...z];return ke[ve]=X,ke})},_=[{id:"user",avatarUrl:"/assets/avatars/avatar_default.jpg",name:"Admin",username:"Admin"},{id:"assistant",avatarUrl:"/assets/avatars/avatar_2.jpg",name:"Copilot",username:"Copilot"}],R={id:"1",participants:_,type:"ONE_TO_ONE",unreadCount:0,messages:t},k=()=>{C([])},P=({content:$,senderId:r,mode:h,sources:j=[],function_calls:L=[],msgId:N=void 0,uuid:O=void 0,timestamp:I=void 0,attachments:w=[],buttonPrompt:U=void 0,thoughts:Y=[]})=>{v({conversationId:"1",messageId:N===void 0?le():N,message:$,contentType:"text",sources:j,function_calls:L,createdAt:new Date,senderId:r,mode:h,chatMode:o,ddb_uuid:O,log_timestamp:I,attachments:w,thoughts:Y},U)},H=f.useCallback(($,r)=>{g($),W(r),i.onTrue()},[i]);return e.jsxs(qe,{sx:{height:"calc(100% + 52px)"},children:[e.jsx(Ee,{title:"Chat bench",sx:{mt:-1,mb:2},action:e.jsx(fe,{title:"Clear histroy",children:e.jsx(F,{size:"small",color:"default",onClick:()=>k(),children:e.jsx(de,{src:"/assets/icons/modules/ic-sweep.svg",sx:{width:24,height:24}})})})}),e.jsx(V,{sx:{borderStyle:"dashed",mb:0}}),e.jsxs(M,{sx:{height:"calc(100% - 62px)"},children:[e.jsx(as,{avatarUrl:n,messages:R==null?void 0:R.messages,participants:[_[1]],onOpenRagSourcePanel:H}),e.jsx(ns,{onSend:P}),e.jsx(Me,{open:i.value,onClose:i.onFalse,ragThoughts:x,selectedSource:T})]})]})}function rs({message:n,participants:c,isLastMessage:u,onOpenLightbox:p,onSend:y,callBack:o}){const{user:a}=Le(),[m,s]=f.useState(""),{me:i,senderDetails:x,hasImage:g}=Gt({message:n,participants:c,currentUserId:`${a==null?void 0:a.id}`}),{firstName:t}=x,C=x.type==="me",{body:T,createdAt:W,buttons:S}=n,D=c===null?[]:c.map(k=>k.id),A=!!n&&!!T&&T.startsWith("(SYS)Working"),B=()=>o&&!!T&&o(T),E=k=>{s(P=>k===P?"":k)},q=k=>{try{return e.jsx(e.Fragment,{children:cs(A,k)})}catch{return e.jsx(M,{sx:{typography:"body2"},children:k.replace("<eos>","")})}},d=k=>e.jsxs(M,{children:[e.jsx(M,{sx:{fontSize:15,py:1},children:k.replace("(SYS)","")}),e.jsx(Ht,{color:"primary",sx:{mt:0,mb:1.5}})]}),l=k=>{try{return e.jsx(b,{spacing:1,sx:{mt:1,mb:1.5},children:k.map((P,H)=>e.jsx(se,{fullWidth:!0,color:"inherit",variant:"outlined",onClick:()=>{y({content:P.button_content,senderId:"user",mode:"new",buttonPrompt:P.button_prompt}),y({content:"(SYS)Working on it...",senderId:D[0],mode:"new"})},children:P.button_content},H))})}catch{return null}},v=e.jsx(te,{noWrap:!0,variant:"caption",sx:{mb:1,color:"text.disabled",...!i&&{mr:"auto"}},children:Vt(new Date(W),{addSuffix:!0})}),_=e.jsxs(b,{sx:{px:1.5,minWidth:48,maxWidth:320,borderRadius:1,typography:"body2",bgcolor:"background.neutral",...i&&{color:"grey.800",bgcolor:"primary.lighter"},...g&&{p:0,bgcolor:"transparent"}},children:[!A&&e.jsx(e.Fragment,{children:g?e.jsx(M,{component:"img",alt:"attachment",src:T,onClick:()=>p(T),sx:{minHeight:220,borderRadius:1.5,cursor:"pointer","&:hover":{opacity:.9}}}):e.jsx(e.Fragment,{children:(n.mode==="attach",q(T))})}),A&&!C&&u&&d(n.body),!!S&&l(S)]}),R=e.jsxs(b,{direction:"row",className:"message-actions",sx:{pt:.5,opacity:0,top:"100%",left:0,position:"absolute",transition:k=>k.transitions.create(["opacity"],{duration:k.transitions.duration.shorter}),...i&&{left:"unset",right:0}},children:[C&&e.jsxs(e.Fragment,{children:[e.jsx(F,{size:"small",children:e.jsx(K,{icon:"solar:reply-bold",width:16})}),e.jsx(F,{size:"small",sx:{width:26,height:26},children:e.jsx(K,{icon:"lucide:copy",width:12})})]}),!C&&e.jsxs(e.Fragment,{children:[e.jsx(F,{size:"small",onClick:B,children:e.jsx(K,{icon:"iconamoon:check-fill",width:16})}),e.jsx(F,{size:"small",color:m!=="Yes"?"default":"success",onClick:()=>E("Yes"),children:e.jsx(K,{icon:"fluent:thumb-like-16-regular",width:16})}),e.jsx(F,{size:"small",color:m!=="No"?"default":"error",onClick:()=>E("No"),children:e.jsx(K,{icon:"fluent:thumb-dislike-16-regular",width:16})})]})]});return e.jsxs(b,{direction:"row",justifyContent:i?"flex-end":"unset",sx:{mb:3},children:[!i&&e.jsx(re,{alt:t,src:"/assets/avatars/avatar_copilot.jpg",sx:{width:30,height:30,mr:2}}),e.jsxs(b,{alignItems:"flex-end",children:[v,e.jsxs(b,{direction:"row",alignItems:"center",sx:{position:"relative","&:hover":{"& .message-actions":{opacity:1}}},children:[_,!A&&!n.buttons&&R]})]})]})}function ls(n){try{JSON.parse(n)}catch{return!1}return!0}function cs(n,c){try{if(n)return null;const u=c.replace("<eos>","");return e.jsx(M,{sx:{wordBreak:"break-word"},children:e.jsx(gt,{sx:{"& p":{fontSize:14},"& code":{fontSize:13,borderRadius:.5,mx:.25,whiteSpace:"pre-wrap"},"& pre, & pre > code":{fontSize:13,p:.75}},children:ls(u)?`\`\`\`json
 ${u}`:u})})}catch{return e.jsx(M,{sx:{typography:"body2"},children:c.replace("<eos>","")})}}function ds({messages:n=[],participants:c,onSend:u,callBack:p}){const{messagesEndRef:y}=Ae(n),o=n.filter(m=>m.contentType==="image").map(m=>({src:m.body})),a=Ge(o);return e.jsxs(e.Fragment,{children:[e.jsx(ye,{ref:y,sx:{px:2.25,py:3,height:1},children:e.jsx(M,{children:n.map(m=>e.jsx(rs,{message:m,participants:c,isLastMessage:n.indexOf(m)===n.length-1,onOpenLightbox:()=>a.onOpen(m.body),onSend:u,callBack:p},m.id))})}),e.jsx(Je,{index:a.selected,slides:o,open:a.open,close:a.onClose})]})}function ms({conversationId:n,onSend:c}){const{user:u}=Le(),[p,y]=f.useState(""),o=()=>{p&&(c({content:p,senderId:"user",mode:"new"}),c({content:"(SYS)Working on it...",senderId:"assistant",mode:"new"}),y(""))},a=m=>{(m.metaKey||m.ctrlKey)&&m.key==="Enter"&&o()};return e.jsxs(b,{direction:"row",spacing:2,sx:{pt:2,pb:2.75,px:2.25},children:[e.jsx(re,{sx:{width:32,height:32},src:u==null?void 0:u.photoURL,alt:u==null?void 0:u.displayName}),e.jsxs(et,{variant:"outlined",sx:{p:1,flexGrow:1,bgcolor:"transparent"},children:[e.jsx(Bt,{fullWidth:!0,multiline:!0,rows:2,value:p,onChange:m=>y(m.target.value),placeholder:"Type a message",onKeyDown:a,sx:{px:1}}),e.jsxs(b,{direction:"row",alignItems:"center",children:[e.jsxs(b,{direction:"row",flexGrow:1,children:[e.jsx(F,{children:e.jsx(K,{icon:"solar:gallery-add-bold"})}),e.jsx(F,{children:e.jsx(K,{icon:"eva:attach-2-fill"})})]}),e.jsx(se,{size:"small",variant:"contained",onClick:o,children:"Send"})]})]})]})}const us=n=>[{id:"123",body:"Hi! I'll help you build a custom GPT. Once you've named your GPT, I'll walk you through the rest.",contentType:"text",sources:[],function_calls:[],buttons:[{button_id:"1",button_content:"Generate description",button_prompt:`Please generate a short description for a custom GPT named ${n} around 30 words.`},{button_id:"2",button_content:"Generate system prompt",button_prompt:`I want you to help me write a detailed instruction (system prompt) for a custom GPT named ${n}. It should start like: "You are a helpful ...". The total number of words should be no more than 200.`},{button_id:"3",button_content:"Generate 3 sample prompts",button_prompt:`Please generate 3 sample prompts for a custom GPT named ${n}. Each prompt should be more than 15 words but less than 30 words.`}],createdAt:new Date,senderId:"e12f09a7-dd88-49d5-b1c8-1daf80c2d7b1",mode:"new",chatMode:"open-chat"}];function ps({trigger:n,context:c,open:u,onClose:p,callBack:y,...o}){const a="open-chat",[m,s]=f.useState([]),[i,x]=f.useState(n);f.useEffect(()=>{if(n&&n!==i){const l=us(c);s(l),x(n)}},[n,c,i]);const g=ge(je),t=g?g.map(l=>l.resourceName):[],C=g?g.filter(l=>l.primary):[],T=C&&C.length>0?C[0].resourceName:"";let W="";T.length>0?W=T:t&&t.length>0&&(W=t[0]);const S=we(W),D=S[`${a}-Past messages included`],A=(l,v)=>{const{messageId:_,message:R,contentType:k,sources:P,function_calls:H,createdAt:$,senderId:r,mode:h,ddb_uuid:j,log_timestamp:L,attachments:N}=l,O={id:_,body:R,contentType:k,sources:P,function_calls:H,createdAt:$,senderId:r,mode:h,chatMode:a,ddb_uuid:j,log_timestamp:L,attachments:N};s(I=>{const w=I.findIndex(Y=>Y.id===_);if(!R)return[...I];if(w===-1){if(h==="attach"){if(R.startsWith("(SYS)function")){const G={...I[I.length-1],body:R,function_calls:H};return R.startsWith("(SYS)function executed")&&ee({mode:a,onSend:d,request:Z([...I.slice(0,-1),G],a,D,S),shouldStream:S[`${a}-Should stream`],aoaiResourceName:S[`${a}-Deployment`],systemPrompt:S[`${a}-System message`]}),[...I.slice(0,-1),G]}const Y=I[I.length-1].function_calls;return[...I.slice(0,-1),{...I[I.length-1],body:R,...Y&&{function_calls:Y}}]}return h==="new"&&R!=="(SYS)Working on it..."&&r==="assistant"?[...I.slice(0,-1),O]:h==="new"&&r==="user"?(v?ee({mode:a,onSend:d,request:Z([...I,O],a,D,S),shouldStream:S[`${a}-Should stream`],aoaiResourceName:S[`${a}-Deployment`],buttonContent:v,systemPrompt:S[`${a}-System message`]}):ee({mode:a,onSend:d,request:Z([...I,O],a,D,S),shouldStream:S[`${a}-Should stream`],aoaiResourceName:S[`${a}-Deployment`],systemPrompt:S[`${a}-System message`]}),[...I,O]):[...I,O]}const U=[...I];return U[w]=O,U})},B=[{id:"user",avatarUrl:"/assets/avatars/avatar_default.jpg",name:"Admin",username:"Admin"},{id:"assistant",avatarUrl:"/assets/avatars/avatar_2.jpg",name:"Copilot",username:"Copilot"}],E={id:"1",participants:B,type:"ONE_TO_ONE",unreadCount:0,messages:m},q=()=>{s(l=>[l[0]])},d=({content:l,senderId:v,mode:_,sources:R=[],function_calls:k=[],msgId:P=void 0,uuid:H=void 0,timestamp:$=void 0,attachments:r=[],buttonPrompt:h=void 0})=>{A({conversationId:"1",messageId:P===void 0?le():P,message:l,contentType:"text",sources:R,function_calls:k,createdAt:new Date,senderId:v,mode:_,chatMode:a,ddb_uuid:H,log_timestamp:$,attachments:r},h)};return e.jsxs(tt,{open:u,onClose:p,anchor:"right",slotProps:{backdrop:{invisible:!0}},PaperProps:{sx:{width:{xs:1,sm:400}}},...o,children:[e.jsx(b,{spacing:2.5,justifyContent:"center",sx:{p:2.5},children:e.jsxs(b,{direction:"row",justifyContent:"space-between",children:[e.jsxs(b,{direction:"row",spacing:1,alignItems:"center",children:[e.jsx(M,{component:"img",src:"/assets/icons/modules/ic_copilot.svg",sx:{width:26,height:26}}),e.jsx(te,{variant:"h6",children:" Copilot "})]}),e.jsxs(b,{direction:"row",justifyContent:"flex-end",flexGrow:1,spacing:.25,children:[e.jsx(fe,{title:"Clear histroy",children:e.jsx(F,{size:"small",color:"default",onClick:q,children:e.jsx(de,{src:"/assets/icons/modules/ic-sweep.svg",sx:{width:20,height:20}})})}),e.jsx(F,{size:"small",onClick:p,sx:{width:30},children:e.jsx(K,{icon:Jt,width:19,height:19})})]})]})}),e.jsx(V,{sx:{borderStyle:"solid",mb:0}}),e.jsx(ds,{messages:E==null?void 0:E.messages,participants:[B[1]],onSend:d,callBack:y}),e.jsx(ms,{conversationId:E.id,onSend:d})]})}function hs({values:n,setValue:c}){const[u]=f.useState(0),{tools:p}=Ue(),{kmmList:y}=yt(u),o=p.map(s=>`${s.id}<sep>${s.name}`),a=y.map(s=>`${s.name}<sep>${s.index}`),m=s=>{const i=p.filter(x=>x.id===s)[0];return i?i.cover:""};return e.jsxs(b,{spacing:1.5,children:[e.jsxs(b,{direction:"row",children:[e.jsx($e,{name:"function",size:"medium",labelPlacement:"end",label:"Tool",sx:{flexGrow:1,width:140},onClick:()=>{n.function&&c("functionList",[])}}),!!n.function&&e.jsx(he,{fullWidth:!0,name:"functionList",size:"small",placeholder:"+ Tools",multiple:!0,isOptionEqualToValue:(s,i)=>s===i,options:o.map(s=>s),getOptionLabel:s=>s.split("<sep>")[1],renderOption:(s,i)=>f.createElement("li",{...s,key:i},e.jsxs(b,{direction:"row",spacing:1.5,alignItems:"center",children:[e.jsx(re,{sx:{width:24,height:24},alt:i.split("<sep>")[0],src:m(i.split("<sep>")[0])}),i.split("<sep>")[1]]})),renderTags:(s,i)=>s.map((x,g)=>f.createElement(xe,{...i({index:g}),key:x,label:x.split("<sep>")[1],size:"small",color:"default",variant:"soft",avatar:e.jsx(re,{alt:x.split("<sep>")[0],src:m(x.split("<sep>")[0])})}))})]}),e.jsxs(b,{direction:"row",children:[e.jsx($e,{name:"knowledge",labelPlacement:"end",label:"Knowledge",sx:{flexGrow:1,width:140},onClick:()=>{n.knowledge&&c("knowledgeBase","")}}),!!n.knowledge&&e.jsx(he,{fullWidth:!0,name:"knowledgeBase",size:"small",placeholder:"+ Knowledge",options:a.map(s=>s),getOptionLabel:s=>s.split("<sep>")[0],renderOption:(s,i)=>f.createElement("li",{...s,key:i},i.split("<sep>")[0]),renderTags:(s,i)=>s.map((x,g)=>f.createElement(xe,{...i({index:g}),key:x,label:x.split("<sep>")[0],size:"small",color:"primary",variant:"soft"}))})]})]})}function xs({samplePrompts:n,onUpdateSamplePrompt:c,onDeleteSamplePrompt:u,attachments:p,onUpdateAttachments:y}){const o=(s,i)=>{c(s,i)},a=f.useCallback((s,i)=>{const x=s.map(g=>Object.assign(g,{preview:URL.createObjectURL(g)}));y(x,i,"add")},[y]),m=f.useCallback((s,i)=>{y([s],i,"remove")},[y]);return n.length===0?null:e.jsx(b,{sx:{mt:1.5},spacing:2,children:n.map((s,i)=>e.jsxs(b,{direction:"row",alignItems:"center",spacing:.5,children:[e.jsx(qt,{fullWidth:!0,multiline:!0,maxRows:3,size:"small",placeholder:"",value:s,onChange:x=>{o(i,x.target.value)},inputProps:{style:{fontSize:"14px"}}}),e.jsx(b,{direction:"row",alignItems:"center",children:p&&`prompt-${i}`in p&&e.jsx(Ye,{thumbnail:!0,files:p[`prompt-${i}`],onRemove:x=>m(x,i),sx:{width:39,height:39,borderRadius:1}})}),e.jsx(ze,{onDrop:x=>a(x,i),sx:{width:30,height:30,mr:-.25},placeholder:e.jsx(K,{icon:"solar:gallery-add-bold",width:20})}),e.jsx(F,{size:"small",onClick:()=>{u(i)},children:e.jsx(K,{icon:Qt})})]},i))})}const gs=["Writing","Productivity","Programming","Image","Lifestyle","Education"],fs=[{value:"custom",label:"Custom"},{value:"dalle",label:"Dall·E"}];function js({methods:n,attachments:c,onUpdateAttachments:u}){const p=ce(),[y,o]=f.useState(""),[a]=f.useState(null),[m,s]=f.useState(!1),[i,x]=f.useState([]),{watch:g,setValue:t}=n,C=g(),T=d=>{o(d)},W=d=>{o(d)},S=()=>{t("samplePrompts",[...C.samplePrompts,""])},D=(d,l)=>{t("samplePrompts",C.samplePrompts.map((v,_)=>_===d?l:v))},A=d=>{t("samplePrompts",C.samplePrompts.filter((l,v)=>v!==d))},B=f.useCallback(d=>{const l=d[0],v=Object.assign(l,{preview:URL.createObjectURL(l)});l&&t("coverUrl",v,{shouldValidate:!0})},[t]),E=f.useCallback(()=>{t("coverUrl",null)},[t]);async function q(){if(a&&a.text.length>0){const{text:d}=a;s(!0);const l={prompt:d},v=await nt.post(ot,{action:"draw",params:l});s(!1),v.data.image_url&&x(_=>[..._,v.data.image_url])}}return e.jsxs(qe,{sx:{height:"calc(100% + 52px)"},children:[e.jsx(Ee,{title:"Configuration",sx:{mt:-1,mb:2},action:e.jsx(b,{direction:"row",spacing:1,alignItems:"center",sx:{py:-1.5},children:e.jsx(F,{size:"small",onClick:()=>T("config"),children:e.jsx(M,{component:"img",src:"/assets/icons/modules/ic_copilot.svg",sx:{width:26,height:26,cursor:"pointer"}})})})}),e.jsx(V,{sx:{borderStyle:"dashed",mb:.25}}),e.jsx(ye,{sx:{flexDirection:"row"},children:e.jsxs(b,{spacing:2.5,sx:{p:3,pb:11},children:[e.jsx(ae,{name:"name",label:"GPT name"}),e.jsx(ae,{name:"description",label:"Description",multiline:!0,rows:2}),e.jsxs(M,{sx:{position:"relative"},children:[e.jsx(ae,{name:"instruction",label:"System prompt",multiline:!0,rows:3}),e.jsx(F,{onClick:p.onTrue,sx:{p:0,right:2,bottom:2,zIndex:9,opacity:1,width:"18px",height:"18px",position:"absolute",bgcolor:"transparent",justifyContent:"center","&:hover":{opacity:.8}},children:e.jsx(K,{icon:"eva:expand-fill",width:18})})]}),e.jsx(he,{name:"category",label:"Category",placeholder:"Select a category",options:gs.map(d=>d),getOptionLabel:d=>d,renderOption:(d,l)=>f.createElement("li",{...d,key:l},l),renderTags:(d,l)=>d.map((v,_)=>f.createElement(xe,{...l({index:_}),key:v,label:v,size:"small",color:"info",variant:"soft"}))}),e.jsxs(M,{sx:{mt:-.5},children:[e.jsxs(b,{direction:"row",alignItems:"center",justifyContent:"space-between",children:[e.jsx(te,{noWrap:!0,variant:"subtitle2",sx:{textTransform:"capitalize"},children:"Sample prompts"}),e.jsx(F,{size:"small",onClick:S,children:e.jsx(K,{icon:Ft})})]}),e.jsx(xs,{samplePrompts:C.samplePrompts,onUpdateSamplePrompt:D,onDeleteSamplePrompt:A,attachments:c,onUpdateAttachments:u})]}),e.jsx(V,{sx:{borderStyle:"dashed",mb:.25}}),e.jsx(hs,{values:C,setValue:t}),e.jsx(V,{sx:{borderStyle:"dashed",mb:.25}}),e.jsxs(b,{spacing:1.5,sx:{my:0,mt:-1},children:[e.jsxs(b,{direction:"row",alignItems:"center",justifyContent:"space-between",children:[e.jsx(te,{variant:"subtitle2",children:"Cover Image"}),e.jsxs(b,{direction:"row",alignItems:"center",spacing:2,children:[e.jsx(Zt,{row:!0,spacing:3,name:"coverType",options:fs}),C.coverType==="dalle"&&e.jsx(M,{sx:{display:"flex",justifyContent:"flex-end"},children:e.jsxs(st,{sx:{px:1,borderRadius:.75,height:30},onClick:()=>q(),children:[e.jsx(Xt,{children:e.jsx(M,{component:"span",className:"icon",sx:{width:18,color:"secondary.light"},children:e.jsx(de,{src:"/assets/icons/app/ai_content_generator/ic_ai_draw.svg",sx:{width:1,height:1}})})}),e.jsx(It,{primary:"Draw",sx:{ml:-1}})]})})]})]}),C.coverType==="custom"&&e.jsx(Yt,{name:"coverUrl",maxSize:10145728,onDrop:B,onDelete:E}),C.coverType==="dalle"&&e.jsxs(b,{spacing:1.5,children:[m&&e.jsx(b,{direction:"row",spacing:2,children:[...Array(3)].map((d,l)=>e.jsx(dt,{variant:"rectangular",width:"100%",height:180,sx:{mb:l===2?0:3,borderRadius:1}},`b${l}`))}),!m&&i.length>0&&e.jsx(M,{sx:{my:1,display:"grid",gap:2.5,gridTemplateColumns:{xs:"repeat(1, 1fr)",sm:"repeat(2, 1fr)",md:"repeat(3, 1fr)",lg:"repeat(3, 1fr)"}},children:i.map((d,l)=>e.jsx(es,{children:`![Image](${d})`,sx:{my:-2.5}},l))}),!m&&i.length===0&&e.jsx(Oe,{filled:!0,title:"No Images",description:"You can ask AI to draw for you",sx:{pt:6,pb:9}})]})]})]})}),e.jsx(ps,{open:!!y,trigger:y,context:C.name,onClose:()=>T(""),callBack:W}),e.jsxs(We,{fullWidth:!0,maxWidth:"md",open:p.value,onClose:p.onFalse,children:[e.jsx(Rt,{sx:{p:d=>d.spacing(2.5,3,1.5,3)},children:"System prompt"}),e.jsx(Mt,{dividers:!0,sx:{pt:1,pb:0,border:"none",height:"100%"},children:e.jsx(ae,{sx:{maxHeight:"auto"},name:"instruction",multiline:!0,minRows:5,maxRows:30})}),e.jsx(Be,{children:e.jsx(se,{variant:"contained",onClick:p.onFalse,children:"Close"})})]})]})}function ys({id:n}){var H,$;const c=ce(),u=Ne(),{enqueueSnackbar:p}=at(),y=f.useRef(!0),[o,a]=f.useState(),[m,s]=f.useState(!1),{apps:i}=$t(),x=it(),g=n?i.find(r=>r.id===n):null,t=n?{...g&&JSON.parse(g.content),coverUrl:g==null?void 0:g.cover,category:g==null?void 0:g.category}:null,C=u.themeLayout==="horizontal",T=wt().shape({name:J().required("Name is required"),description:J().required("Description is required"),instruction:J().required("System prompt is required"),category:J().required("Category is required"),content:J(),coverUrl:oe().nullable().required("Cover is required"),coverType:J(),status:J(),tags:Pe().min(0),function:me(),functionList:oe().test("functionList","Must have at least one item when Function is turned on.",(r,{parent:h})=>{const{function:j}=h;return!(j&&(!r||r.length===0))}),assistant:me(),assistantName:oe().test("assistantName","Must have at least one item when Assistant is turned on.",(r,{parent:h})=>{const{assistant:j}=h;return!(j&&(!r||r.length===0))}),knowledge:me(),knowledgeBase:oe().test("knowledgeBase","Must have at least one item when Knowledge is turned on.",(r,{parent:h})=>{const{knowledge:j}=h;return!(j&&(!r||r.length===0))}),samplePrompts:Pe().min(0)}),W=f.useMemo(()=>({id:(t==null?void 0:t.id)||le(),name:(t==null?void 0:t.name)||"",description:(t==null?void 0:t.description)||"",instruction:(t==null?void 0:t.instruction)||"",content:"",coverUrl:(t==null?void 0:t.coverUrl)||null,tags:(t==null?void 0:t.tags)||[],status:(t==null?void 0:t.status)||"draft",coverType:"custom",category:(t==null?void 0:t.category)||"",function:(t==null?void 0:t.function)||!1,functionList:(t==null?void 0:t.functionList)||[],knowledge:(t==null?void 0:t.knowledge)||!1,knowledgeBase:(t==null?void 0:t.knowledgeBase)||"",assistant:(t==null?void 0:t.assistant)||!1,assistantName:(t==null?void 0:t.assistantName)||"",samplePrompts:(t==null?void 0:t.samplePrompts)||[]}),[t]),S=St({resolver:vt(T),defaultValues:W}),{reset:D,watch:A,control:B,setValue:E,handleSubmit:q,formState:{isValid:d}}=S,l=A(),v=f.useCallback(async r=>{if(!r)return[];const h=[];return r.forEach(async(j,L)=>{if(Pt(j)){const N=JSON.parse(j);if("content"in N&&h.push(N.content),"attachments"in N){const O=N.attachments.map(async w=>typeof w!="string"||w.startsWith("https://")?w:await Tt(w)),I=await Promise.all(O);a(w=>({...w,[`prompt-${L}`]:I}))}}else h.push(j)}),h},[]),_=f.useCallback((r,h,j)=>{r&&a(L=>{const N=L?L[`prompt-${h}`]||[]:[];return{...L,[`prompt-${h}`]:j==="add"?[...N,...r]:N.filter(O=>O!==r[0])}})},[]);f.useEffect(()=>{g&&y.current&&(y.current=!1,(async()=>{D(W);const h=await v(t.samplePrompts);E("samplePrompts",h)})())},[D,E,g,t,W,v]);const R=q(async r=>{try{s(!0);const h=new FormData;let j="";if(typeof r.coverUrl!="string")h.append("file",r.coverUrl),j=`${r.id}.${r.coverUrl.name.split(".").pop()||"jpg"}`;else if(g){const w=g.cover.split("?")[0].split(".").pop();j=`${r.id}.${w}`}o&&Object.entries(o).forEach(([w,U])=>{U.forEach((Y,G)=>{typeof Y!="string"&&h.append(`${w}-${G}`,Y)})});const L=r.samplePrompts.map((w,U)=>{if(o&&Object.keys(o).includes(`prompt-${U}`)){const Y={content:w,attachments:o[`prompt-${U}`].map(G=>{if(typeof G!="string"){const Q=le().substring(0,6);return h.append(`prompt-${U}-${Q}`,G),`${r.id}-prompt-${U}-${Q}.${G.name.split(".").pop()||"jpg"}`}return G.split("?")[0].split("/").pop()})};return JSON.stringify(Y)}return w}),N={...r,samplePrompts:L};delete N.coverUrl;const O=g?{...g,content:JSON.stringify(N),cover:j,category:r.category,status:r.status,dateModified:new Date,scenarios:r.tags.map(w=>({color:"primary",title:w})),title:r.name}:{id:r.id,category:r.category,content:JSON.stringify(N),source:"custom",status:r.status,cover:`${r.id}.${r.coverUrl.name.split(".").pop()||"jpg"}`,dateCreated:new Date,dateModified:new Date,maintainers:[{avatar:"/assets/avatars/avatar_1.jpg",email:"admin@gbb_ai.com",name:"Lei",permission:"view"}],scenarios:r.tags.map(w=>({color:"primary",title:w})),title:r.name,type:"Text"},I=JSON.stringify(O);h.append("appData",I),await _t(h).then(w=>{w&&w.success?(p(w.message,{variant:"success"}),x.push(pe.gbbai.gpts.edit(O.id))):p(w.message,{variant:"error"})}).catch(w=>{p(w,{variant:"error"}),console.error("An error occurred while uploading the custom GPT:",w)}),s(!1)}catch(h){console.error(h),s(!1)}}),k=C?"calc(100vh - 336px)":"calc(100vh - 230px)",P=o?Object.entries(o).map(([r,h])=>[r,h.map(j=>typeof j=="string"?j:`${j==null?void 0:j.preview}`)]).reduce((r,[h,j])=>({...r,[h]:j}),{}):{};return e.jsx(De,{maxWidth:u.themeStretch?!1:"xl",children:e.jsxs(Ct,{methods:S,onSubmit:R,children:[e.jsx(Nt,{heading:t?"Edit":"Create custom GPT",links:[{name:"List",href:pe.gbbai.gpts.root},{name:t?t.name:"New GPT"}],action:e.jsxs(b,{direction:"row",spacing:1,alignItems:"center",children:[e.jsx(Se,{control:e.jsx(be,{name:"status",control:B,render:({field:r})=>e.jsx(Ve,{...r,size:"small",checked:r.value==="published",onChange:h=>r.onChange(h.target.checked?"published":"draft")})}),label:"Publish"}),e.jsx(se,{size:"small",color:"inherit",variant:"outlined",onClick:c.onTrue,children:"Preview"}),e.jsx(He,{size:"small",type:"submit",variant:"contained",loading:m,startIcon:e.jsx(K,{icon:kt}),onClick:R,children:"Upload"})]}),sx:{mb:3}}),e.jsxs(ue,{container:!0,spacing:3,children:[e.jsx(ue,{xs:12,md:6,sx:{width:"100%",height:k},children:e.jsx(js,{methods:S,attachments:o,onUpdateAttachments:_})}),e.jsx(ue,{xs:12,md:6,sx:{width:"100%",height:k},children:e.jsx(is,{avatarUrl:typeof l.coverUrl=="string"?l.coverUrl:`${(H=l.coverUrl)==null?void 0:H.preview}`,instruction:l.instruction,functionList:l.functionList,knowledgeBase:l.knowledgeBase?l.knowledgeBase:""},JSON.stringify(l))})]}),e.jsx(ss,{title:l.name,instruction:l.instruction||"",description:l.description,coverUrl:typeof l.coverUrl=="string"?l.coverUrl:`${($=l.coverUrl)==null?void 0:$.preview}`,samplePrompts:l.samplePrompts||[],functionList:l.functionList,knowledgeBase:l.knowledgeBase?l.knowledgeBase:"",attachments:P,open:c.value,isValid:d,isSubmitting:m,onClose:c.onFalse,onSubmit:R},JSON.stringify(l))]})})}function xn(){const n=lt(),{id:c}=n;return e.jsxs(e.Fragment,{children:[e.jsx(rt,{children:e.jsx("title",{children:" GBB/AI: Edit Agent"})}),e.jsx(ys,{id:c})]})}export{xn as default};
