import{r as b,j as e,S as O,h as z,A as Z,N,T as q,m as M,C as ne,D as ee,a9 as oe,e as ie,d as D,o as U}from"./index-f7c4dfad.js";import{b as ae,u as re}from"./tool-f255544f.js";import{m as K}from"./api-c77678a4.js";import{u as le,o as G}from"./use-messages-scroll-6244af21.js";import{u as te,a as se}from"./use-light-box-1c577ab5.js";import{b as ce,c as de,d as me}from"./custom-gpt-chat-bench-message-item-2678e8e2.js";import{i as pe}from"./json-string-62cd4b84.js";import{g as he}from"./app-gallery-78b50b87.js";import{b as ue,C as xe}from"./DialogContent-12fa3194.js";import{_ as ge,U as fe,c as be,a as we}from"./attach-2-fill-7e40e49b.js";import{_ as ye}from"./round-send-ef8614b3.js";import"./coming-soon-image-464dfa9d.js";import{M as Se}from"./preview-multi-file-bce21d5d.js";import"./numeral-b65a1435.js";import"./image-f9ea5de7.js";import{v as je}from"./fade-295cf198.js";import{a as Ce}from"./TextField-5cd6dfc4.js";function ve({title:u,content:n,icon:C,onSend:x,attachments:l}){const[o,g]=b.useState([]),[i,T]=b.useState([]),[w,y]=b.useState(n);async function k(r,h,S){const P=await(await fetch(r)).blob();return new File([P],h,{type:S})}const s=b.useCallback(async()=>{const r=pe(n),h=r?JSON.parse(n):void 0;if(r&&h.attachments){y(h.content);const v=h.attachments.map(async I=>{const c=await he(I),d=c.split("?")[0].split("/").pop(),p=d.split(".").pop(),$=await k(c,d,`image/${p}`);return Object.assign($,{preview:URL.createObjectURL($)}),{avatarSas:c,file:$}});(await Promise.all(v)).forEach(({avatarSas:I,file:c})=>{T(d=>[...d,I]),g(d=>[...d,c])})}else l&&`prompt-${u}`in l&&T([l[`prompt-${u}`][0]])},[u,n,l]);b.useEffect(()=>{s()},[s]);const a=async r=>{r&&(x({content:r,senderId:"user",mode:"new",...i&&i.length>0&&{attachments:o}}),x({content:"(SYS)Working on it...",senderId:"assistant",mode:"new"}))};return e.jsx(ue,{sx:{px:1,py:.25,borderRadius:1,bgcolor:"background.white",boxShadow:r=>r.customShadows.z3,"&:hover":{boxShadow:r=>r.customShadows.z20}},onClick:()=>a(w),children:e.jsxs(O,{direction:"row",spacing:1.5,sx:{p:.25,px:0},alignItems:"center",justifyContent:"space-between",children:[e.jsxs(O,{sx:{py:1},direction:"row",alignItems:"center",children:[i&&i.length>0&&e.jsxs(z,{sx:{ml:1,mx:.75,width:62,height:62,position:"relative"},children:[e.jsx(Z,{alt:`prompt-${u}`,src:i[0],variant:"square",sx:{width:62,height:62,borderRadius:1,border:r=>`solid 1px ${N(r.palette.grey[500],.4)}`}}),i.length>1&&e.jsx(xe,{size:"small",color:"info",label:`+${i.length-1}`,sx:{px:0,top:1.5,right:1.5,height:16,fontSize:"12px",borderRadius:.75,position:"absolute"}})]}),e.jsx(q,{variant:"body2",sx:{px:1,display:"-webkit-box",overflow:"hidden",textOverflow:"ellipsis",WebkitBoxOrient:"vertical",WebkitLineClamp:3},children:w})]}),!!C&&C]})})}const Ie=["jpg","gif","png","gif","bmp","svg","webp"],Q=new RegExp(`https.*\\.(${Ie.join("|")}).*(?=\\))`,"i"),V=/!\[.*?\]\((.*?)\)/g;function Te({gptName:u,avatarUrl:n,description:C,samplePrompts:x,conversation:l,onSend:o,attachments:g,onOpenRagSourcePopover:i}){const{messagesEndRef:T}=le(l.messages),w=l.messages.filter(s=>{if(!s.body)return!1;const a=s.body.match(Q);return!!(a?a[0]:"")}).map(s=>{if(!s.body)return{src:""};const a=s.body.match(Q),r=a?a[0]:"",h=[];let S=V.exec(s.body);for(;S!==null;)S[1]!==r&&h.push(S[1]),S=V.exec(s.body);return[{src:r},...h.map(v=>({src:v}))]}).flat();l.messages.forEach(s=>{s.attachments!==void 0&&s.attachments.length>0&&s.attachments.forEach(a=>{w.push({src:a.preview})})});const y=te(w),k=s=>{y.onOpen(s)};return e.jsxs(e.Fragment,{children:[e.jsxs(M,{ref:T,sx:{py:2,px:1.25,height:1},children:[e.jsxs(z,{sx:{mx:2,mb:8,mt:0},children:[e.jsx(Z,{alt:"copilot",src:n,sx:{width:52,height:52,mx:"auto",mt:4}}),e.jsx(ce,{title:u}),e.jsx(q,{variant:"body1",sx:{mb:2,mt:0,mx:{xs:1,md:5},textAlign:"center",fontWeight:500},children:C}),x.length>0&&e.jsx(q,{variant:"body2",sx:{mb:2,mt:8,textAlign:"center"},children:"Try following prompts"}),e.jsx(z,{sx:{display:"grid",gap:3,gridTemplateColumns:{xs:"repeat(1, 1fr)",sm:"repeat(2, 1fr)",md:"repeat(3, 1fr)",lg:"repeat(3, 1fr)"},width:"100%"},children:x.map((s,a)=>e.jsx(ve,{title:`${a}`,content:s,onSend:o,attachments:g},a))})]}),l.messages.map((s,a)=>e.jsx(de,{message:s,avatarUrl:n,conversation:l,isLastMessage:a===l.messages.length-1,onOpenLightbox:k,onOpenRagSourcePopover:i},s.id))]}),e.jsx(se,{index:y.selected,slides:w,open:y.open,close:y.onClose})]})}function $e({samplePrompts:u,openPopover:n,setOpenPopover:C,setMessage:x}){const l=()=>{C(null)};return e.jsxs(ne,{open:n,onClose:l,arrow:"bottom-center",sx:{width:360},hiddenArrow:!0,children:[e.jsx(q,{variant:"subtitle1",sx:{py:1,pb:1.5,px:1},children:"Prompt library"}),e.jsx(ee,{sx:{borderStyle:"dashed"}}),e.jsx(M,{sx:{mt:1,height:{xs:300,sm:380}},children:e.jsx(oe.div,{variants:je().inUp,children:u.map((o,g)=>e.jsx(me,{selected:!1,onSelectQuery:x,title:o,prompt:o},g))})})]})}function ke({onSend:u,chatMode:n,disabled:C,participants:x,samplePrompts:l}){const o=ie(),[g,i]=b.useState(""),[T,w]=b.useState(!1),[y,k]=b.useState(0),[s,a]=b.useState([]),[r,h]=b.useState(null),S=s.map(t=>({src:t.preview||""})),v=te(S),P=t=>{v.onOpen(t)},I=t=>{h(t.currentTarget)};b.useEffect(()=>{const t=setTimeout(()=>{c()},50);return()=>clearTimeout(t)},[g]);const c=()=>{const t=document.querySelector(".llm-input");if(t){let f;t.clientHeight<60?f=1:t.clientHeight>=60&&t.clientHeight<80?f=2:t.clientHeight>=80&&t.clientHeight<100?f=3:f=4,k(f)}},d=t=>{w(t)},p=t=>{(t.metaKey||t.ctrlKey)&&t.key==="Enter"&&F()},$=x===null?[]:x.map(t=>t.id),F=()=>{!g&&s.length===0||x===null||(u({content:g,senderId:"user",mode:"new",attachments:s}),u({content:"(SYS)Working on it...",senderId:$[0],mode:"new"}),i(""),a([]),k(1))},R=b.useCallback(t=>{const f=t.map(A=>Object.assign(A,{preview:URL.createObjectURL(A)}));a([...s,...f])},[s]),E=b.useCallback(t=>{const f=s.filter(A=>A!==t);a(f)},[s]);let j;return s.length>0?j=1:y<2?j=20:y===2?j=2.5:y===3?j=2:j=1.5,e.jsxs(z,{sx:{minHeight:52,display:"flex",position:"absolute",alignItems:"center",bottom:-64,width:"100%",paddingLeft:o.spacing(1),backgroundColor:o.palette.background.paper,py:.5,boxShadow:T?`0 0 1px 0 ${N(o.palette.mode==="light"?o.palette.grey[500]:o.palette.grey[200],.32)}, 0 1px 10px 2px ${N(o.palette.mode==="light"?o.palette.grey[800]:o.palette.grey[700],.1)}`:`0 0 1px 0 ${N(o.palette.mode==="light"?o.palette.grey[500]:o.palette.grey[200],.32)}, 0 1px 4px -1px ${N(o.palette.mode==="light"?o.palette.grey[800]:o.palette.grey[700],.34)}`,borderRadius:j},children:[e.jsxs(O,{sx:{mr:1},children:[e.jsx(D,{size:"small",onClick:I,children:e.jsx(U,{icon:ge,width:22})}),e.jsx($e,{setMessage:i,openPopover:r,samplePrompts:l,setOpenPopover:h})]}),e.jsxs(O,{sx:{width:"100%"},alignItems:"center",children:[e.jsx(O,{direction:"row",flexWrap:"wrap",sx:{display:s.length===0?"none":"flex",width:"100%",mt:.75,ml:-1},children:e.jsx(Se,{thumbnail:!0,files:s,onRemove:t=>E(t),sx:{width:64,height:64},onClick:P})}),e.jsx(Ce,{className:"llm-input",multiline:!0,maxRows:10,fullWidth:!0,value:g,disableUnderline:!0,onBlur:()=>d(!1),onFocus:()=>d(!0),onKeyDown:p,onChange:t=>i(t.target.value),placeholder:"Enter a prompt",endAdornment:e.jsxs(O,{direction:"row",sx:{mr:.5,"& > *":{mx:.25}},alignItems:"center",children:[e.jsx(fe,{disabled:n!=="open-chat",onDrop:R}),e.jsx(D,{disabled:C,size:"small",onClick:()=>{},children:e.jsx(U,{icon:be,width:20,height:20})}),e.jsx(D,{disabled:C,size:"small",children:e.jsx(U,{icon:we,width:20,height:20})})]}),sx:{pb:.5}})]}),e.jsx(ee,{orientation:"vertical",flexItem:!0}),e.jsx(D,{disabled:g.trim().length===0&&s.length===0,onClick:F,sx:{mx:1,mr:.75},color:"primary",children:e.jsx(U,{icon:ye,width:24,height:24})}),e.jsx(se,{index:v.selected,slides:S,open:v.open,close:v.onClose})]})}const Re={id:"user",name:"Admin"},X=[{id:"assistant",name:"GPT"}];function Ke({gptName:u,chatMode:n,avatarUrl:C,description:x,samplePrompts:l,messages:o,onUpdateMessages:g,configurations:i,selectedIndex:T,functionList:w,sampleAttachments:y,onOpenRagSourcePopover:k}){const{tools:s}=ae();let a=[],r=[];w&&w.length>0&&(a=s.filter(c=>w.some(d=>{const[p]=d.split("<sep>");return p===c.id&&c.meta.trim()!==""})),r=a.map(c=>JSON.parse(c.meta)));const h=i[`${n}-Past messages included`],S=c=>{const{messageId:d,message:p,contentType:$,sources:F,function_calls:R,createdAt:E,senderId:j,mode:t,ddb_uuid:f,log_timestamp:A,attachments:L,thoughts:B}=c,_={id:d,body:p,contentType:$,sources:F,function_calls:R,createdAt:E,senderId:j,mode:t,chatMode:n,ddb_uuid:f,log_timestamp:A,attachments:L,thoughts:B};g(m=>{const H=m.findIndex(W=>W.id===d);if(!p&&(L==null?void 0:L.length)===0)return[...m];if(H===-1){if(t==="attach"){if(p.startsWith("(SYS)function")){const J={...m[m.length-1],body:p,function_calls:R};return p.startsWith("(SYS)function executed")&&K({mode:n,onSend:I,request:G([...m.slice(0,-1),J],n,h,i,[],r),shouldStream:i[`${n}-Should stream`],aoaiResourceName:i[`${n}-Deployment`],indexName:T,systemPrompt:i[`${n}-System message`],selectedTools:a}),[...m.slice(0,-1),J]}const W=m[m.length-1].function_calls;return[...m.slice(0,-1),{...m[m.length-1],body:p,...W&&{function_calls:W},...B&&{thoughts:B}}]}return t==="new"&&p!=="(SYS)Working on it..."&&j==="assistant"?[...m.slice(0,-1),_]:t==="new"&&j==="user"?(K({mode:n,onSend:I,request:G([...m,_],n,h,i,[],r),shouldStream:i[`${n}-Should stream`],aoaiResourceName:i[`${n}-Deployment`],indexName:T,systemPrompt:i[`${n}-System message`],selectedTools:a}),[...m,_]):[...m,_]}const Y=[...m];return Y[H]=_,Y})},v=[X[0]],P={id:"1",participants:[Re,X[0]],type:"ONE_TO_ONE",unreadCount:0,messages:o},I=({content:c,senderId:d,mode:p,sources:$=[],function_calls:F=[],msgId:R=void 0,uuid:E=void 0,timestamp:j=void 0,attachments:t=[],thoughts:f=[]})=>{S({conversationId:"1",messageId:R===void 0?re():R,message:c,contentType:"text",sources:$,function_calls:F,createdAt:new Date,senderId:d,mode:p,chatMode:n,ddb_uuid:E,log_timestamp:j,attachments:t,thoughts:f})};return e.jsxs(O,{sx:{width:1,height:1,overflow:"hidden"},children:[e.jsx(Te,{gptName:u,avatarUrl:C,description:x,samplePrompts:l,conversation:P,onSend:I,attachments:y,onOpenRagSourcePopover:k}),e.jsx(ke,{samplePrompts:l,participants:v,onSend:I,disabled:!0,chatMode:n})]})}export{Ke as C};
