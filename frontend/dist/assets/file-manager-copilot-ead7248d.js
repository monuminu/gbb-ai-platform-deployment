import{O as fe,Q as je,s as ce,R as ye,r as m,U as be,_ as we,j as e,V as Ce,X as ie,Y as Se,e as de,b as ve,A as Z,N as he,i as ue,B as I,I as f,C as Ae,M as K,D as ee,m as se,S as u,T as E,h as S,d as A,x as xe,n as Ie,a as ke,y as Re,z as Me,E as re,F as Te}from"./index-f7c4dfad.js";import{f as Fe,L as De,D as We,u as _e}from"./tool-f255544f.js";import{D as Ne,c as ze,a as Pe}from"./DialogContent-12fa3194.js";import{T as Oe,L as $e,I as Le}from"./TextField-5cd6dfc4.js";import{I as He}from"./numeral-b65a1435.js";import{u as Ue,_ as Ee}from"./use-get-message-377020ea.js";import{m as J}from"./api-c77678a4.js";import{u as Be,g as Ye,o as Q}from"./use-messages-scroll-6244af21.js";import{j as Ve,R as qe}from"./rag-source-dialog-bf54fa9f.js";import{L as Ge,u as Ke,a as Je}from"./use-light-box-1c577ab5.js";import{M as Qe}from"./markdown-e1ecb202.js";import"./image-f9ea5de7.js";import{F as Xe,f as Ze}from"./file-thumbnail-ebe9c7d7.js";function es(s){return je("MuiCardActionArea",s)}const ss=fe("MuiCardActionArea",["root","focusVisible","focusHighlight"]),X=ss,ts=["children","className","focusVisibleClassName"],os=s=>{const{classes:t}=s;return Se({root:["root"],focusHighlight:["focusHighlight"]},es,t)},ns=ce(ye,{name:"MuiCardActionArea",slot:"Root",overridesResolver:(s,t)=>t.root})(({theme:s})=>({display:"block",textAlign:"inherit",borderRadius:"inherit",width:"100%",[`&:hover .${X.focusHighlight}`]:{opacity:(s.vars||s).palette.action.hoverOpacity,"@media (hover: none)":{opacity:0}},[`&.${X.focusVisible} .${X.focusHighlight}`]:{opacity:(s.vars||s).palette.action.focusOpacity}})),is=ce("span",{name:"MuiCardActionArea",slot:"FocusHighlight",overridesResolver:(s,t)=>t.focusHighlight})(({theme:s})=>({overflow:"hidden",pointerEvents:"none",position:"absolute",top:0,right:0,bottom:0,left:0,borderRadius:"inherit",opacity:0,backgroundColor:"currentcolor",transition:s.transitions.create("opacity",{duration:s.transitions.duration.short})})),rs=m.forwardRef(function(t,o){const n=be({props:t,name:"MuiCardActionArea"}),{children:i,className:a,focusVisibleClassName:r}=n,x=we(n,ts),j=n,g=os(j);return e.jsxs(ns,Ce({className:ie(g.root,a),focusVisibleClassName:ie(r,g.focusVisible),ref:o,ownerState:j},x,{children:[i,e.jsx(is,{className:g.focusHighlight,ownerState:j})]}))}),ks=rs;function Rs(){const[s,t]=m.useState(null);return{copiedText:s,copy:async n=>{if(!(navigator!=null&&navigator.clipboard))return console.warn("Clipboard not supported"),!1;try{return await navigator.clipboard.writeText(n),t(n),!0}catch(i){return console.warn("Copy failed",i),t(null),!1}}}}function as({person:s}){const t=de(),[o,n]=m.useState(s.permission),i=ve(),a=m.useCallback(r=>{n(r)},[]);return e.jsxs(e.Fragment,{children:[e.jsxs(Fe,{sx:{px:0,py:1},children:[e.jsx(Z,{alt:s.name,src:s.photo?s.photo:s.avatarUrl,sx:{mr:2,border:`2px solid ${he(t.palette.divider,.08)}`}}),e.jsx(De,{primary:s.name,secondary:e.jsx(ue,{title:s.email,children:e.jsx("span",{children:s.email})}),primaryTypographyProps:{noWrap:!0,typography:"subtitle2"},secondaryTypographyProps:{noWrap:!0,component:"span"},sx:{flexGrow:1,pr:1}}),e.jsxs(I,{size:"small",color:"inherit",endIcon:e.jsx(f,{width:20,icon:i.open?"eva:arrow-ios-upward-fill":"eva:arrow-ios-downward-fill",sx:{ml:-1}}),onClick:i.onOpen,sx:{flexShrink:0,...i.open&&{bgcolor:"action.selected"}},children:["Can ",o]})]}),e.jsx(Ae,{open:i.open,onClose:i.onClose,sx:{width:160},children:e.jsxs(e.Fragment,{children:[e.jsxs(K,{selected:o==="view",onClick:()=>{i.onClose(),a("view")},children:[e.jsx(f,{icon:"solar:eye-bold"}),"Can view"]}),e.jsxs(K,{selected:o==="edit",onClick:()=>{i.onClose(),a("edit")},children:[e.jsx(f,{icon:"solar:pen-bold"}),"Can edit"]}),e.jsx(ee,{sx:{borderStyle:"dashed"}}),e.jsxs(K,{onClick:()=>{i.onClose()},sx:{color:"error.main"},children:[e.jsx(f,{icon:"gravity-ui:trash-bin",width:18}),"Remove"]})]})})]})}function Ms({shared:s,inviteEmail:t,onCopyLink:o,onChangeInvite:n,open:i,onClose:a,...r}){const x=s&&!!s.length;return e.jsxs(Ne,{fullWidth:!0,maxWidth:"xs",open:i,onClose:a,...r,children:[e.jsx(We,{children:" Invite "}),e.jsxs(ze,{sx:{overflow:"unset"},children:[n&&e.jsx(Oe,{fullWidth:!0,value:t,placeholder:"Email",onChange:n,InputProps:{endAdornment:e.jsx(He,{position:"end",children:e.jsx(I,{color:"inherit",variant:"contained",disabled:!t,sx:{mr:-.75},children:"Send Invite"})})},sx:{mb:2}}),x&&e.jsx(se,{sx:{maxHeight:60*6},children:e.jsx($e,{disablePadding:!0,children:s.map(j=>e.jsx(as,{person:j},j.id))})})]}),e.jsxs(Pe,{sx:{justifyContent:"space-between"},children:[o&&e.jsx(I,{startIcon:e.jsx(f,{icon:"eva:link-2-fill"}),onClick:o,children:"Copy link"}),a&&e.jsx(I,{variant:"outlined",color:"inherit",onClick:a,children:"Close"})]})]})}function ls({data:s}){const t=de();return e.jsx(u,{spacing:1.5,sx:{mt:0,mb:2},children:s.map((o,n)=>{const{label:i,url:a}=o;return e.jsxs(u,{direction:"row",spacing:1,alignItems:"center",sx:{p:1,px:1.25,border:`${he(t.palette.divider,.18)} 1px solid`,borderRadius:1},children:[e.jsx(E,{variant:"overline",sx:{mr:-.5,minWidth:12},children:n+1}),e.jsx(Xe,{file:a,sx:{width:20,height:20}}),e.jsx(E,{variant:"caption",children:i})]},n)})})}function cs({message:s,participants:t,isLastMessage:o,onOpenLightbox:n,onOpenRagSourcePanel:i}){const{user:a}=xe(),r=Ve(s.thoughts),[x,j]=m.useState(""),{me:g,senderDetails:P,hasImage:D}=Ue({message:s,participants:t,currentUserId:`${a==null?void 0:a.id}`}),{firstName:k}=P,y=P.type==="me",{body:b,createdAt:W,sources:R}=s,w=!!s&&!!b&&b.startsWith("(SYS)Working"),p=d=>{j(l=>d===l?"":d)},_=d=>{try{return e.jsxs(e.Fragment,{children:[hs(w,d)," ",s.thoughts&&s.thoughts.length>2&&O()]})}catch{return e.jsx(S,{sx:{typography:"body2"},children:d.replace("<eos>","")})}},B=d=>e.jsxs(S,{children:[e.jsx(S,{sx:{fontSize:15,py:1},children:d.replace("(SYS)","")}),e.jsx(Ge,{color:"primary",sx:{mt:0,mb:1.5}})]}),O=()=>s&&s.body&&!y&&!w&&e.jsxs(e.Fragment,{children:[e.jsx(ee,{sx:{borderStyle:"dashed",mb:.75,mt:0}}),e.jsx(u,{spacing:1,direction:"row",alignItems:"center",sx:{mb:.85,maxWidth:"100%",scrollbarWidth:"none","&::-webkit-scrollbar":{display:"none"}},children:s.thoughts&&s.thoughts.length>2&&e.jsxs(e.Fragment,{children:[e.jsxs(I,{sx:{px:0,py:0,width:68,fontSize:"12px",fontWeight:600,color:"text.secondary"},onClick:()=>i(s.thoughts,"All"),children:["Sources (",r.length,")"]}),e.jsx(se,{sx:{flexGrow:1,maxWidth:1},children:e.jsx(u,{display:"flex",spacing:1,direction:"row",children:r.length>0&&r.map((d,l)=>e.jsx(S,{children:e.jsx(I,{variant:"soft",color:"info",size:"medium",startIcon:e.jsx(f,{icon:"codicon:book",sx:{height:14,mx:-.5}}),sx:{pl:1.25,pr:.75,height:24,fontSize:"12px",fontWeight:400,overflow:"auto",textTransform:"none",textOverflow:"ellipsis",whiteSpace:"noWrap",borderRadius:.5,justifyContent:"flex-start",scrollbarWidth:"none","&::-webkit-scrollbar":{display:"none"}},onClick:()=>{i(s.thoughts,d)},children:d})},l))})})]})})]}),N=e.jsx(E,{noWrap:!0,variant:"caption",sx:{mb:1,color:"text.disabled",...!g&&{mr:"auto"}},children:Ze(new Date(W),{addSuffix:!0})}),Y=e.jsxs(u,{sx:{px:1.5,minWidth:48,maxWidth:320,borderRadius:1,typography:"body2",bgcolor:"background.neutral",...g&&{color:"grey.800",bgcolor:"primary.lighter"},...D&&{p:0,bgcolor:"transparent"}},children:[!w&&e.jsx(e.Fragment,{children:D?e.jsx(S,{component:"img",alt:"attachment",src:b,onClick:()=>n(b),sx:{minHeight:220,borderRadius:1.5,cursor:"pointer","&:hover":{opacity:.9}}}):e.jsx(e.Fragment,{children:_(b)})}),w&&!y&&o&&B(s.body),R&&R.length>0&&e.jsx(ls,{data:R})]}),M=e.jsxs(u,{direction:"row",className:"message-actions",sx:{pt:.5,opacity:0,top:"100%",left:0,position:"absolute",transition:d=>d.transitions.create(["opacity"],{duration:d.transitions.duration.shorter}),...g&&{left:"unset",right:0}},children:[y&&e.jsxs(e.Fragment,{children:[e.jsx(A,{size:"small",children:e.jsx(f,{icon:"solar:reply-bold",width:16})}),e.jsx(A,{size:"small",sx:{width:26,height:26},children:e.jsx(f,{icon:"lucide:copy",width:12})})]}),!y&&e.jsxs(e.Fragment,{children:[e.jsx(A,{size:"small",color:x!=="Yes"?"default":"success",onClick:()=>p("Yes"),children:e.jsx(f,{icon:"fluent:thumb-like-16-regular",width:16})}),e.jsx(A,{size:"small",color:x!=="No"?"default":"error",onClick:()=>p("No"),children:e.jsx(f,{icon:"fluent:thumb-dislike-16-regular",width:16})})]})]});return e.jsxs(u,{direction:"row",justifyContent:g?"flex-end":"unset",sx:{mb:3},children:[!g&&e.jsx(Z,{alt:k,src:"/assets/avatars/avatar_copilot.jpg",sx:{width:30,height:30,mr:2}}),e.jsxs(u,{alignItems:"flex-end",children:[N,e.jsxs(u,{direction:"row",alignItems:"center",sx:{position:"relative","&:hover":{"& .message-actions":{opacity:1}}},children:[Y,!w&&!s.buttons&&M]})]})]})}function ds(s){try{JSON.parse(s)}catch{return!1}return!0}function hs(s,t){try{if(s)return null;const o=t.replace("<eos>","");return e.jsx(S,{sx:{wordBreak:"break-word"},children:e.jsx(Qe,{sx:{"& p":{fontSize:14},"& code":{fontSize:13,borderRadius:.5,mx:.25,whiteSpace:"pre-wrap"},"& pre, & pre > code":{fontSize:13,p:.75}},children:ds(o)?`\`\`\`json
 ${o}`:o})})}catch{return e.jsx(S,{sx:{typography:"body2"},children:t.replace("<eos>","")})}}function us({messages:s=[],participants:t,onOpenRagSourcePanel:o}){const{messagesEndRef:n}=Be(s),i=s.filter(r=>r.contentType==="image").map(r=>({src:r.body})),a=Ke(i);return e.jsxs(e.Fragment,{children:[e.jsx(se,{ref:n,sx:{px:2.25,py:3,height:1},children:e.jsx(S,{children:s.map(r=>e.jsx(cs,{message:r,participants:t,isLastMessage:s.indexOf(r)===s.length-1,onOpenLightbox:()=>a.onOpen(r.body),onOpenRagSourcePanel:o},r.id))})}),e.jsx(Je,{index:a.selected,slides:i,open:a.open,close:a.onClose})]})}function xs({buttonDisabled:s,onSend:t}){const{user:o}=xe(),[n,i]=m.useState(""),a=()=>{n&&(t({content:n,senderId:"user",mode:"new"}),t({content:"(SYS)Working on it...",senderId:"assistant",mode:"new"}),i(""))},r=x=>{(x.metaKey||x.ctrlKey)&&x.key==="Enter"&&a()};return e.jsxs(u,{direction:"row",spacing:2,sx:{pt:2,pb:2.75,px:2.25},children:[e.jsx(Z,{sx:{width:32,height:32},src:o==null?void 0:o.photoURL,alt:o==null?void 0:o.displayName}),e.jsxs(Ie,{variant:"outlined",sx:{p:1,flexGrow:1,bgcolor:"transparent"},children:[e.jsx(Le,{disabled:s,fullWidth:!0,multiline:!0,rows:2,value:n,onChange:x=>i(x.target.value),placeholder:"Type a message",onKeyDown:r,sx:{px:1}}),e.jsx(u,{direction:"row",justifyContent:"flex-end",children:e.jsx(I,{disabled:s,size:"small",variant:"contained",onClick:a,children:"Send"})})]})]})}const ae=(s,t)=>{const o={id:"123",body:"👋  I'm here to chat with you. <br/> Please selecte one Knowledge base.",contentType:"text",sources:[],function_calls:[],buttons:[],createdAt:new Date,senderId:"e12f09a7-dd88-49d5-b1c8-1daf80c2d7b1",mode:"new",chatMode:"rag"};if(s==="")return[o];if(t.length>0){let n="👋  I'm here to chat with you, guided by the <strong>Indexed</strong> files you've chosen from the list.";return t[0].type.toLowerCase()==="kb"?(t.length>1?n="👋  I'm here to chat with you, guided by the knowledge base you've chosen from the list. <br/> Only one knowledge base will be used.":n=n.replace("files","knowledge abse"),[{...o,body:n,sources:[{label:t[0].name,url:"folder"}]}]):[{...o,body:n,sources:t.filter(i=>i.status==="Indexed").map(i=>({label:i.name,url:i.type}))}]}return[{...o,body:"👋  I'm here to have a chat with you, pulling from this <strong>entire</strong> knowledge base."}]},le="rag";function Ts({indexName:s,selectedKbs:t,open:o,onClose:n,callBack:i,...a}){const r=ke(),[x,j]=m.useState(),[g,P]=m.useState("All"),[D,k]=m.useState(ae(s,t));m.useEffect(()=>{const l=ae(s,t);D.length===0?k(l):k(v=>[l[0],...v.slice(1)])},[s,t]);const y=Re(Te),b=y?y.map(l=>l.resourceName):[],W=y?y.filter(l=>l.primary):[],R=W&&W.length>0?W[0].resourceName:"";let w="";R.length>0?w=R:b&&b.length>0&&(w=b[0]);const p=Ye(w),_=p[`${le}-Past messages included`],B=(l,v)=>{const{messageId:$,message:C,contentType:V,sources:L,function_calls:H,createdAt:q,senderId:z,mode:T,chatMode:h,ddb_uuid:pe,log_timestamp:ge,attachments:me,thoughts:G}=l,F={id:$,body:C,contentType:V,sources:L,function_calls:H,createdAt:q,senderId:z,mode:T,chatMode:h,ddb_uuid:pe,log_timestamp:ge,attachments:me,thoughts:G};k(c=>{const te=c.findIndex(U=>U.id===$);if(!C)return[...c];if(te===-1){if(T==="attach"){if(C.startsWith("(SYS)function")){const ne={...c[c.length-1],body:C,function_calls:H};return C.startsWith("(SYS)function executed")&&J({mode:h,onSend:M,request:Q([...c.slice(0,-1),ne],h,_,p),shouldStream:p[`${h}-Should stream`],aoaiResourceName:p[`${h}-Deployment`],indexName:s}),[...c.slice(0,-1),ne]}const U=c[c.length-1].function_calls;return[...c.slice(0,-1),{...c[c.length-1],body:C,...U&&{function_calls:U},...G&&{thoughts:G}}]}return T==="new"&&C!=="(SYS)Working on it..."&&z==="assistant"?[...c.slice(0,-1),F]:T==="new"&&z==="user"?(v?J({mode:h,onSend:M,request:Q([...c,F],h,_,p),shouldStream:p[`${h}-Should stream`],aoaiResourceName:p[`${h}-Deployment`],buttonContent:v,indexName:s}):J({mode:h,onSend:M,request:Q([...c,F],h,_,p),shouldStream:p[`${h}-Should stream`],aoaiResourceName:p[`${h}-Deployment`],indexName:s}),[...c,F]):[...c,F]}const oe=[...c];return oe[te]=F,oe})},O=[{id:"user",avatarUrl:"/assets/avatars/avatar_default.jpg",name:"Admin",username:"Admin"},{id:"assistant",avatarUrl:"/assets/avatars/avatar_2.jpg",name:"Copilot",username:"Copilot"}],N={id:"1",participants:O,type:"ONE_TO_ONE",unreadCount:0,messages:D},Y=()=>{k(l=>[l[0]])},M=({content:l,senderId:v,mode:$,sources:C=[],function_calls:V=[],msgId:L=void 0,uuid:H=void 0,timestamp:q=void 0,attachments:z=[],buttonPrompt:T=void 0,thoughts:h=[]})=>{B({conversationId:"1",messageId:L===void 0?_e():L,message:l,contentType:"text",sources:C,function_calls:V,createdAt:new Date,senderId:v,mode:$,chatMode:le,ddb_uuid:H,log_timestamp:q,attachments:z,thoughts:h},T)},d=m.useCallback((l,v)=>{j(l),P(v),r.onTrue()},[r]);return e.jsxs(Me,{open:o,onClose:n,anchor:"right",slotProps:{backdrop:{invisible:!0}},PaperProps:{sx:{width:{xs:1,sm:400}}},...a,children:[e.jsx(u,{spacing:2.5,justifyContent:"center",sx:{p:2.5},children:e.jsxs(u,{direction:"row",justifyContent:"space-between",children:[e.jsxs(u,{direction:"row",spacing:1,alignItems:"center",children:[e.jsx(S,{component:"img",src:"/assets/icons/modules/ic_copilot.svg",sx:{width:26,height:26}}),e.jsx(E,{variant:"h6",children:" Copilot "})]}),e.jsxs(u,{direction:"row",justifyContent:"flex-end",flexGrow:1,spacing:.25,children:[e.jsx(ue,{title:"Clear histroy",children:e.jsx(A,{size:"small",color:"default",onClick:Y,children:e.jsx(re,{src:"/assets/icons/modules/ic-sweep.svg",sx:{width:20,height:20}})})}),e.jsx(A,{size:"small",color:"default",sx:{width:30},onClick:()=>{},children:e.jsx(re,{src:"/assets/icons/modules/ic-settings-outline.svg",sx:{width:19,height:19}})}),e.jsx(A,{size:"small",onClick:n,sx:{width:30},children:e.jsx(f,{icon:Ee,width:19,height:19})})]})]})}),e.jsx(ee,{sx:{borderStyle:"solid",mb:0}}),e.jsx(us,{messages:N==null?void 0:N.messages,participants:[O[1]],onOpenRagSourcePanel:d}),e.jsx(xs,{buttonDisabled:s.length===0,onSend:M}),e.jsx(qe,{open:r.value,onClose:r.onFalse,ragThoughts:x,selectedSource:g})]})}export{ks as C,Ms as F,Ts as a,as as b,Rs as u};
