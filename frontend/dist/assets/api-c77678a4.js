import{y as U,F as D,bo as R}from"./index-f7c4dfad.js";import{u as F,e as E,t as j,h as J}from"./tool-f255544f.js";async function*Y(n){const t=n.getReader();let o="",s=new TextDecoder("utf-8");for(;;){const{done:h,value:u}=await t.read();if(h)break;var l=s.decode(u,{stream:!0});const c=l.split(`
`);for(const e of c)try{o+=e,yield JSON.parse(o),o=""}catch{}}}const N=n=>{const t={"Content-Type":"application/json"};return t.Authorization=`Bearer ${localStorage.getItem("accessToken")}`,t},B=n=>new Promise((t,o)=>{const s=new FileReader;s.readAsDataURL(n),s.onload=()=>{t(s.result)},s.onerror=l=>{o(l),console.error(l)}}),q=async n=>await(await fetch(`https://r.jina.ai/${n}`)).text(),z=async(n,t)=>{const o=n.choices[0].message.function_call.arguments,s=n.choices[0].message.function_call?n.choices[0].message.function_call.name:"",l=o?JSON.parse(o):{};t({content:`(SYS)function calling: ${s}`,senderId:"assistant",mode:"attach",function_calls:[{funcName:s,funcArgs:o,results:""}]});try{const h=Object.entries(l).filter(([e,r])=>r!=null&&r!=="").map(([e,r])=>`${e}='${E(r)}'`).join(", "),u=`${s}(${h})`,c=await j(u);if(c&&c.status===200){let e;if(typeof c.data=="string")try{const r=JSON.parse(c.data);e=r.hasOwnProperty("result")?r.result:r}catch{e=c.data}else e=c.data.hasOwnProperty("result")?c.data.result:c.data;t({content:`(SYS)function executed: ${s}`,senderId:"assistant",mode:"attach",function_calls:[{funcName:s,funcArgs:o,results:e}]})}else if(c&&c.status>299){const e=`Error: ${c.status}  ${c.statusText}`;t({content:e,senderId:"assistant",mode:"new"})}}catch(h){t({content:h,senderId:"assistant",mode:"new"})}},K=async(n,t,o,s)=>{var h,u;if(!o){s({content:"Tool execution failed. Please select a tool first.",senderId:"assistant",mode:"new"});return}const l=t?JSON.parse(t):{};s({content:`(SYS)function calling: ${n}`,senderId:"assistant",mode:"attach",function_calls:[{funcName:n,funcArgs:t,results:""}]});try{const{type:c,params:e,apiAuth:r}=o;if(c.toLowerCase()==="openapi"){const g=((h=e.find(i=>i.name==="url"))==null?void 0:h.value)||"",b=((u=e.find(i=>i.name==="method"))==null?void 0:u.value)||"",m=t||"",d=e.filter(i=>!["url","method","path","requestBody"].includes(i.name)),f=(r==null?void 0:r.apiKey)||"",w=b.toLowerCase()==="get"?l:d.reduce((i,I)=>(i[I.name]=I.value,i),{});let A=g;(g.match(/\{[^}]+\}/g)||[]).forEach(i=>{const I=i.slice(1,-1);w&&w[I]&&(A=A.replace(i,encodeURIComponent(w[I])),delete w[I])});const a=`${A}${J(w||{})}`;(!a||!b)&&s({content:"Error: API URL not found",senderId:"assistant",mode:"new"});const y={method:b,headers:{Authorization:`${f}`,"Content-Type":"application/json"},...b.toLowerCase()!=="get"&&{body:m}},p=await fetch(a,y);if(!p.ok){const i=`HTTP error! status: ${p.status}`;s({content:i,senderId:"assistant",mode:"new"})}const $=await p.json();if($){let i;typeof $=="object"?i=JSON.stringify($):i=$,s({content:`(SYS)function executed: ${n}`,senderId:"assistant",mode:"attach",function_calls:[{funcName:n,funcArgs:t,results:i}]})}else{const i=`Error: ${p.status}  ${p.statusText}`;s({content:i,senderId:"assistant",mode:"new"})}}else if(c.toLowerCase()==="python"){const g=Object.entries(l).filter(([d,f])=>f!=null&&f!=="").map(([d,f])=>`${d}='${E(f)}'`).join(", "),b=`${n}(${g})`,m=await j(b);if(m&&m.status===200){let d;if(typeof m.data=="string")try{const f=JSON.parse(m.data);d=f.hasOwnProperty("result")?f.result:f}catch{d=m.data}else d=m.data.hasOwnProperty("result")?m.data.result:m.data,d.includes("Error")&&d.includes("Traceback")&&(d="The function is not available for now.");s({content:`(SYS)function executed: ${n}`,senderId:"assistant",mode:"attach",function_calls:[{funcName:n,funcArgs:t,results:d}]})}else if(m&&m.status>299){const d=`Error: ${m.status}  ${m.statusText}`;s({content:d,senderId:"assistant",mode:"new"})}}}catch(c){s({content:c,senderId:"assistant",mode:"new"})}};function M(n){let t="",o="";return n.forEach(s=>{const l=s.choices[0].delta,h=l.content,u=l.function_call;if(h===null&&u){const c=u.name;t=c||t,o+=u.arguments?u.arguments:""}}),[t,o]}const S=async(n,t,o)=>{let s="",l=[],h=[],u={};const c=(e,r)=>new Promise(g=>{s+=e,n(s,l,r||"running"),g(null)});try{for await(const e of Y(t)){const r=e.choices[0].finish_reason||null;if(e.choices&&e.choices[0].context&&e.choices[0].context.thoughts)l=e.choices[0].context.thoughts.length>0?e.choices[0].context.thoughts:[],e.choices[0].message=e.choices[0].delta,u=e;else if(e.choices&&e.choices[0].delta.content)await c(e.choices[0].delta.content);else if(e.choices&&e.choices[0].context)u.choices[0].context={...u.choices[0].context,...e.choices[0].context};else if(e.choices&&e.choices[0].delta.function_call)h.push(e);else if(r==="function_call"){const g=M(h);o&&o(g[0],g[1])}else if(r==="stop"||r==="length")await c("","idle");else if(e.error)throw Error(e.error)}}catch(e){n(e.message)}};async function C(n,t,o,s){return fetch(`${R}/aoai`,{method:"POST",headers:N(),body:JSON.stringify({...n,aoai_config:o,...s!==void 0&&{stream:s}})})}const H=async(n,t,o,s,l)=>o?fetch(`${R}/chat`,{method:"POST",headers:N(),body:JSON.stringify({...n,aoai_config:l,embedding_config:s,ai_search_config:{index_name:o}})}):null,Q=async({mode:n,onSend:t,request:o,shouldStream:s,aoaiResourceName:l,indexName:h=void 0,buttonContent:u=void 0,systemPrompt:c=void 0,messageId:e=void 0,selectedTools:r=[]})=>{try{const g=(a,y,p)=>{e?t(e,a,"completed"):t({content:a,senderId:"assistant",mode:"attach",msgId:F(),status:p||"idle",...y&&y.length>0&&{thoughts:y}})},b=(a,y)=>{const p=r.filter($=>$.meta.includes(a))[0]||null;K(a,y,p,t)},m=o.messages.map(async a=>{const{role:y,content:p,attachments:$,name:i,function_call:I,sources:v}=a;let k=p;if(v&&v.length>0){const O=/^(ftp|http|https):\/\/[^ "]+$/;if(v.filter(T=>O.test(T.url)).length>0){const T=await Promise.all(v.map(async P=>{const L=await q(P.url);return`${P.url}
${L}`})).then(P=>P.join(`

`));k=`${p} 

 You can refer to the web information below: 
 ${T}`}}if(n!=="function-calling"&&$&&$.length>0){const O=await Promise.all($.map(async x=>({type:"image_url",image_url:{url:x.preview.startsWith("data:")?x.preview:await B(x)}})));return{role:y,content:[...O,{type:"text",text:k}]}}return{role:y,content:k,...i&&{name:i},...I&&{function_call:I}}}),d={...o,messages:[...await Promise.all(m),...u?[{content:u,role:"user"}]:[]]},f=U(D),w=f&&f.find(a=>a.resourceName===l);if(!w){e?t(e,"No AOAI resource was located. Please add an AOAI resource on the User/Account page first.","completed"):t({content:"No AOAI resource was located. Please add an AOAI resource on the User/Account page first.",senderId:"assistant",mode:"new"});return}const A={api_version:w.apiVersion,azure_endpoint:w.endpoint,api_key:w.key,model:w.model,deployment:w.deployment};let _;if(n==="open-chat")_=await C(d,void 0,A);else if(n==="rag"){const a=f&&f.find(p=>p.model.includes("embedding"));if(!a){t({content:"No text embedding model was found. Please add an Embedding resource on the User/Account page first.",senderId:"assistant",mode:"new"});return}const y={api_version:a.apiVersion,azure_endpoint:a.endpoint,api_key:a.key,model:a.model,deployment:a.deployment};h!==""?_=await H(d,void 0,h,y,A):(t({content:"No custom knowledge was selected. The answer is based on LLM knowledge.",senderId:"assistant",mode:"new"}),_=await C(d,void 0,A))}else _=await C(d,void 0,A);if(_===null){t({content:"No response from server. Please check your configuration.",senderId:"assistant",mode:"new"});return}if(!_.body)throw Error("No response body");if(s)await S(g,_.body,b);else{const a=await _.json();if(_.status>299||!_.ok)throw t({content:a.error,senderId:"assistant",mode:"new"}),Error(a.error||"Unknown error");a&&a.choices&&(a.choices[0].finish_reason==="function_call"?z(a,t):t({content:a.choices[0].message.content,senderId:"assistant",mode:"attach"}))}}catch(g){t({content:g.message,senderId:"assistant",mode:"new"})}};export{C as a,B as c,N as g,S as h,Q as m,z as p};
