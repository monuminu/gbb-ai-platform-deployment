import{u as D,m as R}from"./index-8fda52a8.js";import{bn as C,r as N,ad as A,aL as g,y as O,F as P,bo as F}from"./index-f7c4dfad.js";import{u as V}from"./tool-f255544f.js";import{c as x,a as I,h as G,p as J,g as M}from"./api-c77678a4.js";function B(){const t=g.app.list,{data:e,error:a,isLoading:o,isValidating:n}=D(t,C),[r,i]=N.useState(!1),c=N.useCallback(async()=>{i(!0),await R(t),i(!1)},[t]);return N.useMemo(()=>({apps:e||[],appsLoading:o,appsError:a,appsValidating:n,appsEmpty:!e||!o&&!e.length,appsRefetching:r,refetch:c}),[e,a,c,o,r,n])}async function K(t){const e=t?g.app.customGpt.delete:"";try{const a=await A.post(e,{gptId:t});return a.status===200?(await R(g.app.list,o=>o.filter(r=>r.id!==t),!1),a.data):null}catch(a){return a}}async function W(t){const e=t?g.app.customGpt.create:"";try{const a=await A.post(e,t);if(a.status===200){const o=a.data.item;return await R(g.app.list,n=>{const r=n.map(i=>i.id===o.id?o:i);return n.some(i=>i.id===o.id)||r.push(o),r},!1),a.data}return a}catch(a){return a}}async function j(t){const e=`${g.app.customGpt.sas}/${t}`;try{const a=await A.get(e);return a.status===200?a.data.sas:a}catch(a){return a}}async function H(t,e,a,o,n,r){if(t===""){n(e,"No API was condigured.","completed");return}const i=O(P),c=i&&i.find(d=>d.resourceName===r);if(o.length===0){n(e,"No file was selected. Please select a file first.","completed");return}if(!c){n(e,"No AOAI resource was located. Please add an AOAI resource on the User/Account page first.","completed");return}const f={api_version:c.apiVersion,azure_endpoint:c.endpoint,api_key:c.key,model:c.model,deployment:c.deployment},l=new FormData;o.forEach((d,y)=>{l.append(`file-${y}`,d)}),l.append("query",a),l.append("aoai",JSON.stringify(f));try{const d=await A.post(t,l);d.status===200&&n(e,JSON.stringify(d.data),"completed")}catch(d){n(e,JSON.stringify(d),"failed")}}const T=async(t,e,a,o,n)=>a?fetch(`${F}/manufacturing_copilot`,{method:"POST",headers:M(),body:JSON.stringify({...t,aoai_config:n,embedding_config:o,ai_search_config:{index_name:a}})}):null,Y=async({mode:t,onSend:e,request:a,shouldStream:o,aoaiResourceName:n,indexName:r=void 0,buttonContent:i=void 0,systemPrompt:c=void 0,messageId:f=void 0})=>{try{console.log(r);const l=(s,u)=>{f?e(f,s,"completed"):e({content:s,senderId:"assistant",mode:"attach",msgId:V(),...u&&u.length>0&&{thoughts:u}})},d=a.messages.map(async s=>{const{role:u,content:h,attachments:v,name:b,function_call:E}=s;if(t!=="function-calling"&&v&&v.length>0){const L=await Promise.all(v.map(async k=>({type:"image_url",image_url:{url:k.preview.startsWith("data:")?k.preview:await x(k)}})));return{role:u,content:[...L,{type:"text",text:h}]}}return{role:u,content:h,...b&&{name:b},...E&&{function_call:E}}}),y={...a,messages:[...await Promise.all(d),...i?[{content:i,role:"user"}]:[]]},w=O(P),m=w&&w.find(s=>s.resourceName===n);if(!m){f?e(f,"No AOAI resource was located. Please add an AOAI resource on the User/Account page first.","completed"):e({content:"No AOAI resource was located. Please add an AOAI resource on the User/Account page first.",senderId:"assistant",mode:"new"});return}const _={api_version:m.apiVersion,azure_endpoint:m.endpoint,api_key:m.key,model:m.model,deployment:m.deployment};let p;if(t==="rag"){const s=w&&w.find(h=>h.model.includes("embedding"));if(!s){e({content:"No text embedding model was found. Please add an Embedding resource on the User/Account page first.",senderId:"assistant",mode:"new"});return}const u={api_version:s.apiVersion,azure_endpoint:s.endpoint,api_key:s.key,model:s.model,deployment:s.deployment};r!==""?p=await T(y,void 0,r,u,_):(e({content:"No custom knowledge was selected. The answer is based on LLM knowledge.",senderId:"assistant",mode:"new"}),p=await I(y,void 0,_))}else p=await I(y,void 0,_,!1);if(p===null){e({content:"No response from server. Please check your configuration.",senderId:"assistant",mode:"new"});return}if(!p.body)throw Error("No response body");if(o&&t!=="function-calling")await G(l,p.body);else{const s=await p.json();if(p.status>299||!p.ok)throw e({content:s.error,senderId:"assistant",mode:"new"}),Error(s.error||"Unknown error");s&&s.choices&&(s.choices[0].finish_reason==="function_call"?J(s,e):e({content:s.choices[0].message.content,senderId:"assistant",mode:"attach"}))}}catch(l){e({content:l.message,senderId:"assistant",mode:"new"})}};export{W as a,Y as c,K as d,j as g,H as h,B as u};
